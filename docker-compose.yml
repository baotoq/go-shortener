services:
  # URL Service
  url-service:
    build:
      context: .
      dockerfile: Dockerfile.url-service
    container_name: url-service
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - DATABASE_PATH=/data/shortener.db
      - BASE_URL=http://localhost:8080
      - RATE_LIMIT=100
    volumes:
      - url-data:/data
    restart: unless-stopped

  # URL Service Dapr Sidecar
  url-service-dapr:
    image: daprio/daprd:1.13.0
    container_name: url-service-dapr
    command:
      [
        "./daprd",
        "--app-id", "url-service",
        "--app-port", "8080",
        "--dapr-http-port", "3500",
        "--dapr-grpc-port", "50001",
        "--resources-path", "/components"
      ]
    volumes:
      - ./dapr/components:/components:ro
    network_mode: "service:url-service"
    depends_on:
      url-service:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3500/v1.0/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # Analytics Service
  analytics-service:
    build:
      context: .
      dockerfile: Dockerfile.analytics-service
    container_name: analytics-service
    ports:
      - "8081:8081"
    environment:
      - PORT=8081
      - DATABASE_PATH=/data/analytics.db
      - GEOIP_DB_PATH=/data/GeoLite2-Country.mmdb
    volumes:
      - analytics-data:/data
      - ./data/GeoLite2-Country.mmdb:/data/GeoLite2-Country.mmdb:ro
    restart: unless-stopped

  # Analytics Service Dapr Sidecar
  analytics-service-dapr:
    image: daprio/daprd:1.13.0
    container_name: analytics-service-dapr
    command:
      [
        "./daprd",
        "--app-id", "analytics-service",
        "--app-port", "8081",
        "--dapr-http-port", "3500",
        "--dapr-grpc-port", "50001",
        "--resources-path", "/components"
      ]
    volumes:
      - ./dapr/components:/components:ro
    network_mode: "service:analytics-service"
    depends_on:
      analytics-service:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3500/v1.0/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

volumes:
  url-data:
  analytics-data:
