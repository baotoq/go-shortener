---
phase: 03-enhanced-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/shared/events/click_event.go
  - internal/urlservice/delivery/http/handler.go
  - internal/analytics/enrichment/geoip.go
  - internal/analytics/enrichment/useragent.go
  - internal/analytics/enrichment/referer.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "ClickEvent payload carries client_ip, user_agent, and referer fields"
    - "URL Service redirect handler extracts and publishes client IP, User-Agent, and Referer with each click event"
    - "GeoIP resolver returns ISO country code for valid IPs and 'Unknown' for private/unresolvable IPs"
    - "Device detector returns Desktop, Mobile, Tablet, Bot, or Unknown from User-Agent strings"
    - "Referer classifier returns Search, Social, AI, Direct, or Referral from referer URLs"
  artifacts:
    - path: "internal/shared/events/click_event.go"
      provides: "Extended ClickEvent with enrichment fields"
      contains: "ClientIP"
    - path: "internal/analytics/enrichment/geoip.go"
      provides: "GeoIP country resolver"
      contains: "ResolveCountry"
    - path: "internal/analytics/enrichment/useragent.go"
      provides: "Device type detector"
      contains: "DetectDevice"
    - path: "internal/analytics/enrichment/referer.go"
      provides: "Traffic source classifier"
      contains: "ClassifySource"
  key_links:
    - from: "internal/urlservice/delivery/http/handler.go"
      to: "internal/shared/events/click_event.go"
      via: "publishClickEvent populates ClientIP, UserAgent, Referer"
      pattern: "ClientIP.*UserAgent.*Referer"
---

<objective>
Extend the click event payload with enrichment data (client IP, User-Agent, Referer) and create the three enrichment services that will process this data in the Analytics Service.

Purpose: The URL Service redirect handler is the only place with access to the HTTP request headers. By forwarding these fields in the click event, the Analytics Service can enrich clicks at ingest time without coupling to the redirect path. The enrichment services encapsulate GeoIP resolution, User-Agent parsing, and referer classification as reusable components.

Output: Extended ClickEvent type, updated URL Service publisher, three enrichment services (geoip, useragent, referer), and new Go dependencies.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enhanced-analytics/03-RESEARCH.md
@.planning/phases/03-enhanced-analytics/03-CONTEXT.md
@.planning/phases/02-event-driven-analytics/02-03-SUMMARY.md
@internal/shared/events/click_event.go
@internal/urlservice/delivery/http/handler.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ClickEvent and update URL Service publisher</name>
  <files>
    internal/shared/events/click_event.go
    internal/urlservice/delivery/http/handler.go
  </files>
  <action>
1. **Extend ClickEvent** in `internal/shared/events/click_event.go`:
   - Add three new fields: `ClientIP string`, `UserAgent string`, `Referer string` with json tags `client_ip`, `user_agent`, `referer`
   - Keep existing `ShortCode` and `Timestamp` fields unchanged

2. **Update `publishClickEvent`** in `internal/urlservice/delivery/http/handler.go`:
   - Change method signature from `publishClickEvent(shortCode string)` to `publishClickEvent(shortCode string, clientIP string, userAgent string, referer string)`
   - Populate the new ClickEvent fields: `ClientIP: clientIP`, `UserAgent: userAgent`, `Referer: referer`
   - Update the call site in `Redirect` handler to extract and pass:
     - Client IP: use `r.RemoteAddr` for now (Chi's RealIP middleware already sets this via `r.RemoteAddr` rewriting). Parse with `net.SplitHostPort` to strip port, fallback to raw `r.RemoteAddr` if SplitHostPort fails.
     - User-Agent: `r.Header.Get("User-Agent")`
     - Referer: `r.Header.Get("Referer")`
   - Pass these three values to `publishClickEvent` call in the goroutine
   - Add `"net"` to imports

Note: The `Redirect` handler currently calls `go h.publishClickEvent(code)` after the redirect. Update to `go h.publishClickEvent(code, clientIP, userAgent, referer)` where the values are extracted BEFORE the goroutine (from `r` which may not be available after response is sent).
  </action>
  <verify>
    Run `go build ./cmd/url-service/` — must compile with no errors.
    Run `go vet ./internal/shared/... ./internal/urlservice/...` — no issues.
    Grep for `ClientIP` in click_event.go to confirm field exists.
    Grep for `publishClickEvent` in handler.go to confirm updated signature.
  </verify>
  <done>ClickEvent carries client_ip, user_agent, and referer fields. URL Service redirect handler extracts these from the HTTP request and publishes them with each click event.</done>
</task>

<task type="auto">
  <name>Task 2: Create enrichment services and install dependencies</name>
  <files>
    internal/analytics/enrichment/geoip.go
    internal/analytics/enrichment/useragent.go
    internal/analytics/enrichment/referer.go
    go.mod
    go.sum
  </files>
  <action>
1. **Install dependencies:**
   ```bash
   cd /Users/baotoq/Work/go-shortener
   go get github.com/oschwald/geoip2-golang
   go get github.com/mileusna/useragent
   ```

2. **Create `internal/analytics/enrichment/geoip.go`** — GeoIP country resolver:
   - Struct `GeoIPResolver` with `db *geoip2.Reader` field
   - `NewGeoIPResolver(dbPath string) (*GeoIPResolver, error)` — opens mmdb file, returns error if file not found or corrupt
   - `Close() error` — closes the database reader
   - `ResolveCountry(ipStr string) string` — returns ISO country code ("US", "DE", "JP") or "Unknown"
     - Parse IP with `net.ParseIP(ipStr)` — if nil, return "Unknown"
     - Call `g.db.Country(ip)` — if error, return "Unknown"
     - If `record.Country.IsoCode == ""`, return "Unknown"
     - Otherwise return the IsoCode
   - Import: `"net"`, `geoip2 "github.com/oschwald/geoip2-golang"`

3. **Create `internal/analytics/enrichment/useragent.go`** — Device type detector:
   - Struct `DeviceDetector` (no fields, stateless)
   - `NewDeviceDetector() *DeviceDetector`
   - `DetectDevice(uaString string) string` — returns "Desktop", "Mobile", "Tablet", "Bot", or "Unknown"
     - If `uaString == ""`, return "Unknown"
     - Parse with `useragent.Parse(uaString)`
     - Check `ua.Bot` first → return "Bot" (per user decision: bots tracked separately)
     - Check `ua.Tablet` → return "Tablet"
     - Check `ua.Mobile` → return "Mobile"
     - Check `ua.Desktop` → return "Desktop"
     - Fallback → return "Unknown"
   - Import: `ua "github.com/mileusna/useragent"`

4. **Create `internal/analytics/enrichment/referer.go`** — Traffic source classifier:
   - Struct `RefererClassifier` with `searchEngines []string`, `socialMedia []string`, `aiPlatforms []string` fields
   - `NewRefererClassifier() *RefererClassifier` — initialize with domain lists:
     - searchEngines: `google.com`, `bing.com`, `yahoo.com`, `duckduckgo.com`, `baidu.com`, `yandex.ru`, `ecosia.org`
     - socialMedia: `facebook.com`, `twitter.com`, `x.com`, `instagram.com`, `linkedin.com`, `pinterest.com`, `reddit.com`, `tiktok.com`, `youtube.com`, `threads.net`, `mastodon.social`
     - aiPlatforms: `chatgpt.com`, `claude.ai`, `gemini.google.com`, `perplexity.ai`, `copilot.microsoft.com`
   - `ClassifySource(refererStr string) string` — returns "Search", "Social", "AI", "Direct", or "Referral"
     - If `refererStr == ""`, return "Direct" (empty/missing referer = direct visit, per research)
     - Parse with `url.Parse(refererStr)` — if error, return "Direct"
     - Extract hostname, lowercase, strip "www." prefix
     - Check against searchEngines → "Search"
     - Check against socialMedia → "Social"
     - Check against aiPlatforms → "AI"
     - Default → "Referral"
   - Use `strings.Contains(hostname, domain)` for matching (handles subdomains like m.facebook.com)
   - Import: `"net/url"`, `"strings"`

5. Run `go mod tidy` to clean up dependencies.
  </action>
  <verify>
    Run `go build ./internal/analytics/enrichment/` — must compile.
    Run `go vet ./internal/analytics/enrichment/...` — no issues.
    Verify files exist: `ls internal/analytics/enrichment/geoip.go internal/analytics/enrichment/useragent.go internal/analytics/enrichment/referer.go`
    Run `go build ./...` — entire project compiles.
  </verify>
  <done>Three enrichment services created: GeoIPResolver (country from IP), DeviceDetector (device type from UA), RefererClassifier (traffic source from referer). Dependencies geoip2-golang and mileusna/useragent installed.</done>
</task>

</tasks>

<verification>
1. `go build ./...` — all packages compile
2. `go vet ./...` — no issues
3. ClickEvent has ClientIP, UserAgent, Referer fields
4. URL Service Redirect handler extracts IP, UA, Referer before goroutine and passes to publishClickEvent
5. Three enrichment service files exist in internal/analytics/enrichment/
6. GeoIPResolver, DeviceDetector, RefererClassifier all have their respective methods
</verification>

<success_criteria>
- ClickEvent payload extended with client_ip, user_agent, referer
- URL Service extracts request headers and forwards them in click events
- GeoIP resolver handles valid IPs, private IPs, and malformed input gracefully
- Device detector categorizes into exactly Desktop/Mobile/Tablet/Bot/Unknown
- Referer classifier categorizes into exactly Search/Social/AI/Direct/Referral
- All packages compile and pass go vet
</success_criteria>

<output>
After completion, create `.planning/phases/03-enhanced-analytics/03-01-SUMMARY.md`
</output>
