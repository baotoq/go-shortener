---
phase: 14-log-aggregation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/url-api/etc/url.yaml
  - services/url-api/etc/url-docker.yaml
  - services/analytics-rpc/etc/analytics.yaml
  - services/analytics-rpc/etc/analytics-docker.yaml
  - services/analytics-consumer/etc/consumer.yaml
  - services/analytics-consumer/etc/consumer-docker.yaml
  - docker-compose.yml
  - infra/loki/loki-config.yaml
  - infra/alloy/config.alloy
autonomous: true
requirements:
  - LOG-01
  - LOG-02
  - LOG-03

must_haves:
  truths:
    - "All three services emit structured JSON log lines (not plaintext) to container stdout"
    - "Loki container is running and reachable at http://localhost:3100/ready"
    - "Alloy container discovers all Docker Compose containers and ships logs to Loki"
    - "Log lines from all three services are queryable in Loki using {service=\"url-api\"} style label selectors"
  artifacts:
    - path: "services/url-api/etc/url-docker.yaml"
      provides: "Explicit Encoding: json in Log block"
      contains: "Encoding: json"
    - path: "services/analytics-rpc/etc/analytics-docker.yaml"
      provides: "Explicit Encoding: json in Log block"
      contains: "Encoding: json"
    - path: "services/analytics-consumer/etc/consumer-docker.yaml"
      provides: "Explicit Encoding: json in Log block"
      contains: "Encoding: json"
    - path: "infra/loki/loki-config.yaml"
      provides: "Loki single-binary filesystem config"
      contains: "auth_enabled: false"
    - path: "infra/alloy/config.alloy"
      provides: "Alloy Docker log collection pipeline"
      contains: "loki.source.docker"
    - path: "docker-compose.yml"
      provides: "Loki and Alloy service definitions"
      contains: "grafana/loki"
  key_links:
    - from: "infra/alloy/config.alloy"
      to: "loki:3100"
      via: "loki.write endpoint URL"
      pattern: "http://loki:3100/loki/api/v1/push"
    - from: "docker-compose.yml (alloy)"
      to: "docker-compose.yml (loki)"
      via: "depends_on with service_healthy condition"
      pattern: "depends_on.*loki.*service_healthy"
    - from: "infra/alloy/config.alloy"
      to: "Docker Compose service names"
      via: "discovery.relabel extracting com.docker.compose.service label"
      pattern: "__meta_docker_container_label_com_docker_compose_service"
---

<objective>
Add structured JSON log aggregation to all three services using Loki and Grafana Alloy.

Purpose: Complete the log aggregation layer of the observability stack so all service logs are centrally queryable via Loki, enabling troubleshooting and correlation with distributed traces from Phase 13.

Output: All 6 YAML configs have explicit `Encoding: json`, Loki runs in Docker Compose with filesystem storage, Alloy collects container logs and forwards to Loki with `service` labels derived from Docker Compose service names.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-log-aggregation/14-RESEARCH.md
@docker-compose.yml
@services/url-api/etc/url-docker.yaml
@services/analytics-rpc/etc/analytics-docker.yaml
@services/analytics-consumer/etc/consumer-docker.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add explicit JSON encoding to all service YAML configs and create Loki + Alloy infrastructure</name>
  <files>
    services/url-api/etc/url.yaml
    services/url-api/etc/url-docker.yaml
    services/analytics-rpc/etc/analytics.yaml
    services/analytics-rpc/etc/analytics-docker.yaml
    services/analytics-consumer/etc/consumer.yaml
    services/analytics-consumer/etc/consumer-docker.yaml
    infra/loki/loki-config.yaml
    infra/alloy/config.alloy
  </files>
  <action>
    **Part A — Add `Encoding: json` to all 6 YAML configs (LOG-01):**

    In each of the 6 service YAML config files, add `Encoding: json` to the `Log:` block, between `Mode: console` and `Level: info`. The result should be:

    ```yaml
    Log:
      ServiceName: {service-name}
      Mode: console
      Encoding: json
      Level: info
    ```

    Files to modify (all 6):
    - `services/url-api/etc/url.yaml` (ServiceName: url-api)
    - `services/url-api/etc/url-docker.yaml` (ServiceName: url-api)
    - `services/analytics-rpc/etc/analytics.yaml` (ServiceName: analytics-rpc)
    - `services/analytics-rpc/etc/analytics-docker.yaml` (ServiceName: analytics-rpc)
    - `services/analytics-consumer/etc/consumer.yaml` (ServiceName: analytics-consumer)
    - `services/analytics-consumer/etc/consumer-docker.yaml` (ServiceName: analytics-consumer)

    This makes the JSON encoding explicit and self-documenting. go-zero logx already defaults to JSON, but explicit config is the recommended practice.

    **Part B — Create Loki config (LOG-02):**

    Create `infra/loki/loki-config.yaml` with single-binary filesystem storage config:

    ```yaml
    auth_enabled: false

    server:
      http_listen_port: 3100

    common:
      ring:
        instance_addr: 127.0.0.1
        kvstore:
          store: inmemory
      replication_factor: 1
      path_prefix: /tmp/loki

    schema_config:
      configs:
      - from: "2020-05-15"
        store: tsdb
        object_store: filesystem
        schema: v13
        index:
          prefix: index_
          period: 24h

    storage_config:
      filesystem:
        directory: /tmp/loki/chunks
    ```

    Key decisions: `auth_enabled: false` (no multi-tenancy for local dev), `store: tsdb` + `schema: v13` (Loki 3.x requirement), `from: "2020-05-15"` (must be in the past), filesystem storage (no S3/MinIO needed).

    **Part C — Create Alloy config (LOG-03):**

    Create `infra/alloy/config.alloy` with Docker container log collection pipeline:

    ```alloy
    // Discover all Docker containers
    discovery.docker "containers" {
      host             = "unix:///var/run/docker.sock"
      refresh_interval = "5s"
    }

    // Extract service label from Docker Compose metadata
    discovery.relabel "containers" {
      targets = []

      rule {
        source_labels = ["__meta_docker_container_label_com_docker_compose_service"]
        target_label  = "service"
      }

      rule {
        source_labels = ["__meta_docker_container_name"]
        regex         = "/(.*)"
        target_label  = "container"
      }
    }

    // Collect logs from discovered containers
    loki.source.docker "containers" {
      host             = "unix:///var/run/docker.sock"
      targets          = discovery.docker.containers.targets
      forward_to       = [loki.write.loki.receiver]
      relabel_rules    = discovery.relabel.containers.rules
      refresh_interval = "5s"
    }

    // Write logs to Loki
    loki.write "loki" {
      endpoint {
        url = "http://loki:3100/loki/api/v1/push"
      }
    }
    ```

    Key details: Docker socket discovery for all containers, `service` label from `com.docker.compose.service` Docker label (set by Docker Compose), `container` label from container name. Loki endpoint uses Docker Compose service name `loki`.
  </action>
  <verify>
    ```bash
    # Verify Encoding: json in all 6 YAML files
    grep -c "Encoding: json" services/url-api/etc/url.yaml services/url-api/etc/url-docker.yaml services/analytics-rpc/etc/analytics.yaml services/analytics-rpc/etc/analytics-docker.yaml services/analytics-consumer/etc/consumer.yaml services/analytics-consumer/etc/consumer-docker.yaml

    # Verify infra config files exist
    test -f infra/loki/loki-config.yaml && echo "loki-config.yaml exists" || echo "MISSING"
    test -f infra/alloy/config.alloy && echo "config.alloy exists" || echo "MISSING"

    # Verify Loki config has required fields
    grep "auth_enabled: false" infra/loki/loki-config.yaml
    grep "store: tsdb" infra/loki/loki-config.yaml
    grep "schema: v13" infra/loki/loki-config.yaml

    # Verify Alloy config has Docker discovery and Loki write
    grep "loki.source.docker" infra/alloy/config.alloy
    grep "loki.write" infra/alloy/config.alloy
    grep "__meta_docker_container_label_com_docker_compose_service" infra/alloy/config.alloy

    # Verify Go code still compiles
    go build ./...
    ```
  </verify>
  <done>
    All 6 YAML configs contain `Encoding: json` in their Log block. `infra/loki/loki-config.yaml` exists with auth_enabled: false, tsdb store, schema v13, filesystem storage. `infra/alloy/config.alloy` exists with Docker discovery, service label extraction from Compose metadata, and Loki write endpoint. `go build ./...` passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Loki and Alloy services to Docker Compose</name>
  <files>
    docker-compose.yml
  </files>
  <action>
    Add `loki` and `alloy` services to `docker-compose.yml`, and add `loki-data` to the `volumes:` block.

    **Add Loki service** (place after `jaeger` service, before `analytics-rpc`):

    ```yaml
      loki:
        image: grafana/loki:3.0.0
        ports:
          - "3100:3100"
        volumes:
          - ./infra/loki/loki-config.yaml:/etc/loki/config.yaml
          - loki-data:/tmp/loki
        command: -config.file=/etc/loki/config.yaml
        healthcheck:
          test: ["CMD-SHELL", "wget -q --tries=1 -O- http://localhost:3100/ready || exit 1"]
          interval: 10s
          timeout: 5s
          retries: 5
    ```

    **Add Alloy service** (place after `loki`, before `analytics-rpc`):

    ```yaml
      alloy:
        image: grafana/alloy:v1.7.5
        ports:
          - "12345:12345"
        volumes:
          - ./infra/alloy/config.alloy:/etc/alloy/config.alloy
          - /var/run/docker.sock:/var/run/docker.sock
        command: run --server.http.listen-addr=0.0.0.0:12345 --storage.path=/var/lib/alloy/data /etc/alloy/config.alloy
        depends_on:
          loki:
            condition: service_healthy
    ```

    **Add `loki-data` volume** to the existing `volumes:` block:

    ```yaml
    volumes:
      postgres-data:
      loki-data:
    ```

    **Do NOT modify** the existing `postgres`, `kafka`, `jaeger`, `analytics-rpc`, `url-api`, or `analytics-consumer` service definitions. They already have proper depends_on and need no changes for log aggregation (Alloy collects from all containers automatically via Docker socket).

    Port summary:
    - Loki: 3100 (HTTP API for push/query)
    - Alloy: 12345 (Alloy debug UI, optional but useful)
  </action>
  <verify>
    ```bash
    # Validate Docker Compose syntax
    docker compose config > /dev/null 2>&1 && echo "docker compose config PASS" || echo "FAIL"

    # Verify loki service exists
    docker compose config --services | grep -q loki && echo "loki service found" || echo "MISSING"

    # Verify alloy service exists
    docker compose config --services | grep -q alloy && echo "alloy service found" || echo "MISSING"

    # Verify loki-data volume exists
    grep -q "loki-data:" docker-compose.yml && echo "loki-data volume found" || echo "MISSING"

    # Verify alloy depends on loki
    docker compose config | grep -A5 "alloy:" | grep -q "loki" && echo "alloy depends_on loki" || echo "MISSING"
    ```
  </verify>
  <done>
    `docker compose config` validates successfully. Loki service defined with image `grafana/loki:3.0.0`, port 3100, healthcheck on `/ready`, and `loki-data` named volume. Alloy service defined with image `grafana/alloy:v1.7.5`, port 12345, Docker socket mounted, and `depends_on: loki: condition: service_healthy`. `loki-data` volume added to volumes block.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full log aggregation stack:

1. **Static verification (no Docker required):**
   - `grep -c "Encoding: json"` returns 1 for each of 6 YAML files
   - `infra/loki/loki-config.yaml` contains `auth_enabled: false`, `store: tsdb`, `schema: v13`
   - `infra/alloy/config.alloy` contains `loki.source.docker`, `loki.write`, `__meta_docker_container_label_com_docker_compose_service`
   - `docker compose config` validates without errors
   - `go build ./...` passes

2. **Loki queryability (if Docker available):**
   ```bash
   # After docker compose up, wait for services to start, then:
   curl -s http://localhost:3100/ready
   # Should return "ready"

   curl -s -G http://localhost:3100/loki/api/v1/query_range \
     --data-urlencode 'query={service="url-api"}' \
     --data-urlencode 'limit=5'
   # Should return JSON with log entries from url-api
   ```
</verification>

<success_criteria>
- All 6 YAML configs contain `Encoding: json` in their Log block (LOG-01)
- Loki container is defined in docker-compose.yml with healthcheck and config volume (LOG-02)
- Alloy container is defined in docker-compose.yml with Docker socket and Loki dependency (LOG-03)
- `docker compose config` validates without errors
- `go build ./...` passes (no Go code changes, just config)
- Loki config uses single-binary filesystem storage with auth disabled
- Alloy config extracts `service` label from Docker Compose service name metadata
</success_criteria>

<output>
After completion, create `.planning/phases/14-log-aggregation/14-01-SUMMARY.md`
</output>
