---
phase: 13-distributed-tracing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - services/url-api/etc/url.yaml
  - services/url-api/etc/url-docker.yaml
  - services/analytics-rpc/etc/analytics.yaml
  - services/analytics-rpc/etc/analytics-docker.yaml
  - services/analytics-consumer/etc/consumer.yaml
  - services/analytics-consumer/etc/consumer-docker.yaml
  - services/url-api/internal/logic/redirect/redirectlogic.go
autonomous: true
requirements:
  - TRACE-01
  - TRACE-02
  - TRACE-03

must_haves:
  truths:
    - "Jaeger UI at http://localhost:16686 is accessible after docker compose up"
    - "All three services appear as trace sources in Jaeger after sending a test request"
    - "A single URL redirect produces a connected trace visible in Jaeger spanning HTTP redirect and Kafka consumer"
    - "zRPC calls from url-api to analytics-rpc appear as child spans in Jaeger"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Jaeger all-in-one service with OTLP ports"
      contains: "jaegertracing/all-in-one"
    - path: "services/url-api/etc/url.yaml"
      provides: "Telemetry config for url-api local dev"
      contains: "Telemetry"
    - path: "services/url-api/etc/url-docker.yaml"
      provides: "Telemetry config for url-api Docker"
      contains: "jaeger:4317"
    - path: "services/analytics-rpc/etc/analytics.yaml"
      provides: "Telemetry config for analytics-rpc local dev"
      contains: "Telemetry"
    - path: "services/analytics-rpc/etc/analytics-docker.yaml"
      provides: "Telemetry config for analytics-rpc Docker"
      contains: "jaeger:4317"
    - path: "services/analytics-consumer/etc/consumer.yaml"
      provides: "Telemetry config for analytics-consumer local dev"
      contains: "Telemetry"
    - path: "services/analytics-consumer/etc/consumer-docker.yaml"
      provides: "Telemetry config for analytics-consumer Docker"
      contains: "jaeger:4317"
    - path: "services/url-api/internal/logic/redirect/redirectlogic.go"
      provides: "Fixed Kafka push context propagation"
      contains: "l.svcCtx.KqPusher.Push(l.ctx"
  key_links:
    - from: "services/url-api/etc/url.yaml"
      to: "go-zero Telemetry auto-instrumentation"
      via: "Telemetry YAML block parsed by ServiceConf.MustSetUp()"
      pattern: "Telemetry:"
    - from: "services/url-api/internal/logic/redirect/redirectlogic.go"
      to: "go-queue KqPusher.Push"
      via: "l.ctx carries active HTTP span for OTel header injection"
      pattern: "KqPusher\\.Push\\(l\\.ctx"
    - from: "docker-compose.yml"
      to: "Jaeger OTLP receiver"
      via: "Services send traces to jaeger:4317 in Docker network"
      pattern: "4317:4317"
---

<objective>
Add OpenTelemetry distributed tracing to all three services with Jaeger visualization.

Purpose: Enable end-to-end trace visibility across HTTP requests, zRPC calls, and Kafka async messaging in the URL shortener system.
Output: Jaeger running in Docker Compose receiving OTLP traces from all three services, with connected traces across the Kafka async boundary.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-distributed-tracing/13-RESEARCH.md
@docker-compose.yml
@services/url-api/etc/url.yaml
@services/url-api/etc/url-docker.yaml
@services/analytics-rpc/etc/analytics.yaml
@services/analytics-rpc/etc/analytics-docker.yaml
@services/analytics-consumer/etc/consumer.yaml
@services/analytics-consumer/etc/consumer-docker.yaml
@services/url-api/internal/logic/redirect/redirectlogic.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Jaeger to Docker Compose and update service dependencies</name>
  <files>docker-compose.yml</files>
  <action>
Add a `jaeger` service to `docker-compose.yml` using `jaegertracing/all-in-one:1.76.0`:

```yaml
jaeger:
  image: jaegertracing/all-in-one:1.76.0
  ports:
    - "16686:16686"   # Jaeger UI
    - "4317:4317"     # OTLP gRPC
    - "4318:4318"     # OTLP HTTP
  environment:
    - COLLECTOR_OTLP_ENABLED=true
```

Place `jaeger` service BEFORE `analytics-rpc` in the file (infra services first, then app services).

Update the three application services to depend on Jaeger:
- `analytics-rpc`: add `jaeger: condition: service_started` to its `depends_on`
- `url-api`: add `jaeger: condition: service_started` to its `depends_on`
- `analytics-consumer`: add `jaeger: condition: service_started` to its `depends_on`

Do NOT add a healthcheck to Jaeger â€” `service_started` is sufficient since Jaeger starts quickly and trace loss during startup is acceptable.
  </action>
  <verify>Run `docker compose config` to validate the compose file syntax. Verify Jaeger service is listed with correct ports and all three app services have `jaeger` in depends_on.</verify>
  <done>docker-compose.yml contains Jaeger service with ports 16686/4317/4318 exposed, and all three application services declare depends_on jaeger.</done>
</task>

<task type="auto">
  <name>Task 2: Add Telemetry YAML config to all services and fix Kafka context propagation</name>
  <files>
    services/url-api/etc/url.yaml
    services/url-api/etc/url-docker.yaml
    services/analytics-rpc/etc/analytics.yaml
    services/analytics-rpc/etc/analytics-docker.yaml
    services/analytics-consumer/etc/consumer.yaml
    services/analytics-consumer/etc/consumer-docker.yaml
    services/url-api/internal/logic/redirect/redirectlogic.go
  </files>
  <action>
**Part A: Add Telemetry blocks to all 6 YAML config files.**

For local dev configs (url.yaml, analytics.yaml, consumer.yaml), add this block immediately after the `Log:` section:

```yaml
Telemetry:
  Name: <service-name>       # url-api, analytics-rpc, or analytics-consumer
  Endpoint: localhost:4317
  Sampler: 1.0
  Batcher: otlpgrpc
```

For Docker configs (url-docker.yaml, analytics-docker.yaml, consumer-docker.yaml), add the same block but with `Endpoint: jaeger:4317`:

```yaml
Telemetry:
  Name: <service-name>
  Endpoint: jaeger:4317
  Sampler: 1.0
  Batcher: otlpgrpc
```

The `Name` values for each service:
- url-api configs: `Name: url-api`
- analytics-rpc configs: `Name: analytics-rpc`
- analytics-consumer configs: `Name: analytics-consumer`

IMPORTANT: Use `Batcher: otlpgrpc` (NOT `jaeger`). The Jaeger exporter was removed from OTel Go SDK in 2023. Jaeger v1.76 accepts OTLP natively.

No Go code changes needed for HTTP/zRPC auto-instrumentation. go-zero's `ServiceConf.MustSetUp()` (already called in all three service main functions) reads the `Telemetry` block and initializes the global TracerProvider. The `TracingHandler` middleware (HTTP) and tracing interceptors (gRPC) activate automatically.

**Part B: Fix Kafka trace context propagation.**

In `services/url-api/internal/logic/redirect/redirectlogic.go`, change line 72 from:

```go
if pushErr := l.svcCtx.KqPusher.Push(context.Background(), string(payload)); pushErr != nil {
```

to:

```go
if pushErr := l.svcCtx.KqPusher.Push(l.ctx, string(payload)); pushErr != nil {
```

This passes the HTTP request's span context to `KqPusher.Push()`, which calls `PushWithKey(ctx, ...)` internally. go-queue v1.2.2's `PushWithKey` injects W3C TraceContext headers into Kafka message headers via `otel.GetTextMapPropagator().Inject(ctx, mc)`. On the consumer side, go-queue's `startConsumers()` extracts these headers into the `ctx` passed to `Consume()`.

After this fix, the `context` import in redirectlogic.go is no longer used. Remove the `"context"` import to keep the code clean and prevent compiler warnings.

The `l.ctx` is captured by the `threading.GoSafe` closure at call time (while the HTTP handler is still active). OTel propagation reads trace ID + span ID from the context, not span lifecycle state, so an ended span still propagates correctly.
  </action>
  <verify>
Run `go build ./...` from project root to confirm all services compile without errors.
Run `go vet ./...` to check for issues.
Grep all 6 YAML files for "Telemetry:" to confirm presence.
Grep redirectlogic.go for "l.ctx" to confirm the context fix.
Grep redirectlogic.go for "context.Background" to confirm it is gone from the Push call.
  </verify>
  <done>
All 6 YAML configs contain Telemetry blocks with correct Name, Endpoint (localhost:4317 for local, jaeger:4317 for docker), Sampler 1.0, Batcher otlpgrpc.
redirectlogic.go passes l.ctx to KqPusher.Push instead of context.Background().
All services compile successfully.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `docker compose config` succeeds and shows jaeger service with correct port mapping
2. `go build ./...` passes with no errors
3. All 6 YAML files contain `Telemetry:` block with `Batcher: otlpgrpc`
4. Local YAML files use `Endpoint: localhost:4317`, Docker YAML files use `Endpoint: jaeger:4317`
5. `redirectlogic.go` uses `l.svcCtx.KqPusher.Push(l.ctx, ...)` not `context.Background()`
6. No unused imports in redirectlogic.go

Functional verification (manual, after docker compose up):
- Jaeger UI accessible at http://localhost:16686
- Create a short URL, visit it, then check Jaeger for traces from all three services
- Link detail endpoint (which calls analytics-rpc via zRPC) shows zRPC child spans in the same trace
</verification>

<success_criteria>
- Jaeger container defined in docker-compose.yml with OTLP gRPC on port 4317 and UI on port 16686
- All three services have Telemetry YAML config with otlpgrpc batcher pointing to Jaeger
- Kafka trace context propagation fixed via l.ctx in redirect logic
- All code compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-distributed-tracing/13-01-SUMMARY.md`
</output>
