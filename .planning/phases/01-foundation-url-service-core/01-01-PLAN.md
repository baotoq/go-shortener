---
phase: 01-foundation-url-service-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - sqlc.yaml
  - db/schema.sql
  - db/query.sql
  - migrations/000001_create_urls.up.sql
  - migrations/000001_create_urls.down.sql
  - internal/repository/sqlite/sqlc/db.go
  - internal/repository/sqlite/sqlc/models.go
  - internal/repository/sqlite/sqlc/query.sql.go
  - internal/repository/sqlite/sqlc/querier.go
  - cmd/url-service/main.go
autonomous: true

must_haves:
  truths:
    - "Go module initializes and all dependencies resolve with go mod tidy"
    - "sqlc generates type-safe Go code from SQL schema and queries"
    - "Migration files define the urls table with correct schema"
  artifacts:
    - path: "go.mod"
      provides: "Go module definition with all dependencies"
      contains: "module go-shortener"
    - path: "sqlc.yaml"
      provides: "sqlc configuration for SQLite code generation"
      contains: "engine: sqlite"
    - path: "db/schema.sql"
      provides: "Database schema for sqlc"
      contains: "CREATE TABLE urls"
    - path: "db/query.sql"
      provides: "SQL queries for sqlc code generation"
      contains: "CreateURL"
    - path: "migrations/000001_create_urls.up.sql"
      provides: "Migration to create urls table"
      contains: "CREATE TABLE urls"
    - path: "internal/repository/sqlite/sqlc/query.sql.go"
      provides: "Generated type-safe query functions"
      contains: "func"
  key_links:
    - from: "db/query.sql"
      to: "internal/repository/sqlite/sqlc/query.sql.go"
      via: "sqlc generate"
      pattern: "sqlc generate"
    - from: "db/schema.sql"
      to: "migrations/000001_create_urls.up.sql"
      via: "schema mirrors migration"
      pattern: "CREATE TABLE urls"
---

<objective>
Initialize the Go project with module, dependencies, clean architecture directory structure, SQLite database schema, migration files, and sqlc-generated type-safe query code.

Purpose: Establish the foundation that all subsequent plans build upon -- Go module with dependencies, database schema, and generated data access code.
Output: Working Go module with sqlc-generated code, migration files, and project skeleton ready for business logic.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-url-service-core/01-RESEARCH.md
@.planning/phases/01-foundation-url-service-core/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Go module, install dependencies, create directory structure</name>
  <files>
    go.mod
    go.sum
    cmd/url-service/main.go
  </files>
  <action>
1. Initialize Go module:
   ```
   go mod init go-shortener
   ```

2. Create the clean architecture directory structure:
   ```
   cmd/url-service/
   internal/domain/
   internal/usecase/
   internal/repository/sqlite/sqlc/
   internal/delivery/http/
   migrations/
   db/
   pkg/problemdetails/
   ```

3. Create a minimal `cmd/url-service/main.go` placeholder (just package main + func main with a TODO comment). This will be fully wired in Plan 03.

4. Install all core dependencies:
   ```
   go get github.com/go-chi/chi/v5
   go get modernc.org/sqlite
   go get github.com/golang-migrate/migrate/v4
   go get golang.org/x/time/rate
   go get go.uber.org/zap
   go get github.com/matoous/go-nanoid/v2
   go get github.com/stretchr/testify
   ```

   Note: Also need the migrate source/database drivers:
   ```
   go get github.com/golang-migrate/migrate/v4/source/iofs
   go get github.com/golang-migrate/migrate/v4/database/sqlite3
   ```

5. Run `go mod tidy` to clean up.

Note: sqlc is a CLI tool installed separately (not a Go dependency). Install via:
   ```
   go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest
   ```
  </action>
  <verify>
    - `go mod tidy` exits with code 0 (no errors)
    - `go.mod` contains module name "go-shortener" and all listed dependencies
    - Directory structure exists: cmd/url-service/, internal/domain/, internal/usecase/, internal/repository/sqlite/sqlc/, internal/delivery/http/, migrations/, db/, pkg/problemdetails/
    - `cmd/url-service/main.go` exists and compiles (`go build ./cmd/url-service/`)
  </verify>
  <done>Go module initialized with all dependencies, clean architecture directories created, placeholder main.go compiles</done>
</task>

<task type="auto">
  <name>Task 2: Create database schema, migration files, sqlc config, and generate code</name>
  <files>
    sqlc.yaml
    db/schema.sql
    db/query.sql
    migrations/000001_create_urls.up.sql
    migrations/000001_create_urls.down.sql
    internal/repository/sqlite/sqlc/db.go
    internal/repository/sqlite/sqlc/models.go
    internal/repository/sqlite/sqlc/query.sql.go
    internal/repository/sqlite/sqlc/querier.go
  </files>
  <action>
1. Create `migrations/000001_create_urls.up.sql`:
   ```sql
   CREATE TABLE urls (
       id INTEGER PRIMARY KEY AUTOINCREMENT,
       short_code TEXT NOT NULL UNIQUE,
       original_url TEXT NOT NULL,
       created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
   );

   CREATE UNIQUE INDEX idx_urls_original_url ON urls(original_url);
   ```
   Note: UNIQUE index on original_url enables deduplication (per user decision: duplicate URLs return same short code).

2. Create `migrations/000001_create_urls.down.sql`:
   ```sql
   DROP INDEX IF EXISTS idx_urls_original_url;
   DROP TABLE IF EXISTS urls;
   ```

3. Create `db/schema.sql` (mirrors migration, used by sqlc):
   ```sql
   CREATE TABLE urls (
       id INTEGER PRIMARY KEY AUTOINCREMENT,
       short_code TEXT NOT NULL UNIQUE,
       original_url TEXT NOT NULL,
       created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
   );
   ```

4. Create `db/query.sql` with named queries for sqlc:
   ```sql
   -- name: CreateURL :one
   INSERT INTO urls (short_code, original_url)
   VALUES (?, ?)
   RETURNING *;

   -- name: FindByShortCode :one
   SELECT * FROM urls WHERE short_code = ? LIMIT 1;

   -- name: FindByOriginalURL :one
   SELECT * FROM urls WHERE original_url = ? LIMIT 1;
   ```

5. Create `sqlc.yaml`:
   ```yaml
   version: "2"
   sql:
     - engine: "sqlite"
       queries: "db/query.sql"
       schema: "db/schema.sql"
       gen:
         go:
           package: "sqlc"
           out: "internal/repository/sqlite/sqlc"
           emit_json_tags: true
           emit_interface: true
   ```

6. Run `sqlc generate` to produce Go code in `internal/repository/sqlite/sqlc/`.

7. Verify generated files exist: db.go, models.go, query.sql.go, querier.go (or similar).
  </action>
  <verify>
    - `sqlc generate` exits with code 0
    - Generated files exist in `internal/repository/sqlite/sqlc/` (at minimum: db.go, models.go, query.sql.go)
    - Generated code compiles: `go build ./internal/repository/sqlite/sqlc/`
    - Migration files exist and contain correct SQL
    - `db/schema.sql` and `db/query.sql` are valid SQL
  </verify>
  <done>Database schema defined, migrations created, sqlc generates compilable type-safe Go code for CreateURL, FindByShortCode, and FindByOriginalURL queries</done>
</task>

</tasks>

<verification>
1. `go mod tidy` succeeds with no errors
2. `go build ./cmd/url-service/` compiles the placeholder main
3. `sqlc generate` succeeds and produces Go files
4. `go build ./internal/repository/sqlite/sqlc/` compiles generated code
5. All directories in clean architecture structure exist
</verification>

<success_criteria>
- Go module "go-shortener" initialized with Chi, modernc.org/sqlite, golang-migrate, Zap, go-nanoid, x/time/rate, testify
- Clean architecture directory structure created (cmd, internal/domain, internal/usecase, internal/repository, internal/delivery, pkg)
- SQLite schema with urls table (id, short_code UNIQUE, original_url, created_at) and UNIQUE index on original_url
- Migration files (up + down) for urls table
- sqlc generates compilable Go code from schema and queries
- Everything compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-url-service-core/01-01-SUMMARY.md`
</output>
