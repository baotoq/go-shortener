---
phase: 07-framework-foundation
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - services/analytics-rpc/analytics.proto
  - services/analytics-rpc/analytics.go
  - services/analytics-rpc/etc/analytics-rpc.yaml
  - services/analytics-rpc/analytics/
  - services/analytics-rpc/internal/config/config.go
  - services/analytics-rpc/internal/logic/getclickcountlogic.go
  - services/analytics-rpc/internal/server/analyticsserver.go
  - services/analytics-rpc/internal/svc/servicecontext.go
  - services/analytics-rpc/analyticsclient/analyticsclient.go
  - Makefile
autonomous: true

must_haves:
  truths:
    - "Analytics .proto file defines GetClickCount RPC with request/response messages"
    - "goctl rpc protoc generates server, client, logic, and config without errors"
    - "Analytics RPC service starts on configured port and accepts gRPC connections"
    - "GetClickCount RPC returns stub response with short_code and total_clicks"
    - "Generated client package is importable by URL service for future inter-service calls"
    - "Configuration loaded from YAML file with logx console logging enabled"
  artifacts:
    - path: "services/analytics-rpc/analytics.proto"
      provides: "Protobuf service definition for Analytics RPC"
      contains: "rpc GetClickCount"
    - path: "services/analytics-rpc/analytics.go"
      provides: "Main entry point for Analytics RPC service"
      contains: "zrpc.MustNewServer"
    - path: "services/analytics-rpc/etc/analytics-rpc.yaml"
      provides: "YAML configuration for Analytics RPC service"
      contains: "Name: analytics-rpc"
    - path: "services/analytics-rpc/internal/logic/getclickcountlogic.go"
      provides: "Stub logic returning click count"
      contains: "GetClickCount"
    - path: "services/analytics-rpc/internal/svc/servicecontext.go"
      provides: "ServiceContext with config only (Phase 7 stub)"
      contains: "ServiceContext"
    - path: "services/analytics-rpc/analyticsclient/analyticsclient.go"
      provides: "Generated RPC client for URL service to import"
      contains: "Analytics"
  key_links:
    - from: "services/analytics-rpc/analytics.go"
      to: "services/analytics-rpc/internal/server/"
      via: "server registration"
      pattern: "server\\.Register"
    - from: "services/analytics-rpc/internal/server/"
      to: "services/analytics-rpc/internal/logic/"
      via: "logic constructor in server method"
      pattern: "logic\\.NewGetClickCountLogic"
    - from: "services/analytics-rpc/analyticsclient/"
      to: "services/analytics-rpc/analytics/"
      via: "generated gRPC client using proto stubs"
      pattern: "analytics\\.NewAnalyticsClient"
---

<objective>
Create the Analytics RPC service with protobuf specification, zRPC code generation, and stub logic.

Purpose: Establish the Analytics Service as a bootable go-zero zRPC (gRPC) service with GetClickCount RPC defined, generated client package ready for cross-service calls, and stub response proving the framework skeleton is functional.

Output: Fully generated and customized Analytics RPC service that starts and responds to gRPC calls with stub data.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-framework-foundation/07-RESEARCH.md
@.planning/phases/07-framework-foundation/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write .proto spec and generate Analytics RPC service</name>
  <files>
    services/analytics-rpc/analytics.proto
    services/analytics-rpc/analytics.go (generated)
    services/analytics-rpc/etc/analytics-rpc.yaml (generated)
    services/analytics-rpc/analytics/ (generated proto stubs)
    services/analytics-rpc/internal/config/config.go (generated)
    services/analytics-rpc/internal/logic/getclickcountlogic.go (generated)
    services/analytics-rpc/internal/server/analyticsserver.go (generated)
    services/analytics-rpc/internal/svc/servicecontext.go (generated)
    services/analytics-rpc/analyticsclient/analyticsclient.go (generated)
  </files>
  <action>
  **Step 1: Create the proto directory and write analytics.proto.**

  Create `services/analytics-rpc/analytics.proto`:

  ```protobuf
  syntax = "proto3";

  package analytics;

  option go_package = "./analytics";

  // ========== Messages ==========

  message GetClickCountRequest {
    string short_code = 1;
  }

  message GetClickCountResponse {
    string short_code = 1;
    int64 total_clicks = 2;
  }

  // ========== Service ==========

  // Analytics provides click analytics for shortened URLs.
  // Phase 7: GetClickCount only (minimal scope).
  // Phase 9: Add GetAnalyticsSummary when Kafka consumer is wired.
  service Analytics {
    rpc GetClickCount(GetClickCountRequest) returns (GetClickCountResponse);
  }
  ```

  **Step 2: Ensure protoc and plugins are installed.**

  Check prerequisites:
  ```bash
  protoc --version          # protobuf compiler
  protoc-gen-go --version   # Go protobuf plugin (installed in Plan 01)
  protoc-gen-go-grpc --version  # Go gRPC plugin (installed in Plan 01)
  goctl --version           # go-zero code generator (installed in Plan 01)
  ```

  If `protoc` is not installed, install it:
  ```bash
  # macOS
  brew install protobuf
  # or use goctl to install:
  goctl env check --install --verbose
  ```

  **Step 3: Generate the RPC service using goctl.**

  ```bash
  cd services/analytics-rpc
  goctl rpc protoc analytics.proto --go_out=. --go-grpc_out=. --zrpc_out=. --style gozero
  ```

  This generates:
  - `analytics.go` — main entry point with zrpc.MustNewServer
  - `etc/analytics-rpc.yaml` — config template
  - `analytics/analytics.pb.go` — protobuf message types
  - `analytics/analytics_grpc.pb.go` — gRPC client/server interfaces
  - `analyticsclient/analyticsclient.go` — go-zero wrapped RPC client
  - `internal/config/config.go` — Config struct with zrpc.RpcServerConf
  - `internal/logic/getclickcountlogic.go` — logic stub
  - `internal/server/analyticsserver.go` — gRPC server implementation
  - `internal/svc/servicecontext.go` — ServiceContext

  **Step 4: Verify generation succeeded.**

  ```bash
  ls services/analytics-rpc/analytics/analytics.pb.go
  ls services/analytics-rpc/analytics/analytics_grpc.pb.go
  ls services/analytics-rpc/analyticsclient/analyticsclient.go
  ls services/analytics-rpc/internal/logic/getclickcountlogic.go
  ls services/analytics-rpc/internal/server/analyticsserver.go
  ```

  All files must exist. If goctl reports errors, check:
  - protoc is installed
  - protoc-gen-go and protoc-gen-go-grpc are in $PATH
  - Proto syntax is valid

  **Step 5: Fix import paths if needed.**

  goctl may generate import paths relative to the service directory. They should use the full module path: `go-shortener/services/analytics-rpc/...`. Check generated files and fix if imports are wrong.

  Run `go mod tidy` from the project root to resolve any new dependencies (google.golang.org/grpc, google.golang.org/protobuf if not already present).
  </action>
  <verify>
  - `ls services/analytics-rpc/analytics.proto` exists
  - `ls services/analytics-rpc/analytics.go` exists
  - `ls services/analytics-rpc/analytics/analytics.pb.go` exists
  - `ls services/analytics-rpc/analyticsclient/analyticsclient.go` exists
  - `ls services/analytics-rpc/internal/logic/getclickcountlogic.go` exists
  - `go build ./services/analytics-rpc/...` compiles (may need Task 2 customizations)
  </verify>
  <done>Analytics proto spec written. goctl rpc protoc generates server, client, logic, config, and proto stubs without errors. Generated client package exists for future cross-service import.</done>
</task>

<task type="auto">
  <name>Task 2: Customize Analytics RPC with config, stub logic, and boot verification</name>
  <files>
    services/analytics-rpc/etc/analytics-rpc.yaml
    services/analytics-rpc/internal/config/config.go
    services/analytics-rpc/internal/svc/servicecontext.go
    services/analytics-rpc/internal/logic/getclickcountlogic.go
    Makefile
  </files>
  <action>
  **Step 1: Customize configuration.**

  Edit `services/analytics-rpc/etc/analytics-rpc.yaml`:
  ```yaml
  Name: analytics-rpc
  ListenOn: 0.0.0.0:8081

  Log:
    ServiceName: analytics-rpc
    Mode: console
    Level: info

  # Phase 7: No etcd, no database, no Kafka
  # go-zero zRPC defaults to direct connection mode when Etcd is not configured
  ```

  Note: go-zero zRPC uses Etcd for service discovery by default. Without Etcd config, it runs in direct connection mode (clients connect to ListenOn address directly). This is correct for Phase 7.

  Edit `services/analytics-rpc/internal/config/config.go` if it needs customization beyond the generated default. The generated config already has:
  ```go
  package config

  import "github.com/zeromicro/go-zero/zrpc"

  type Config struct {
      zrpc.RpcServerConf
  }
  ```

  This is sufficient for Phase 7. Phase 8 will add Database config, Phase 9 will add Kafka config.

  **Step 2: Customize ServiceContext (stub for Phase 7).**

  The generated ServiceContext should already be:
  ```go
  package svc

  import "go-shortener/services/analytics-rpc/internal/config"

  type ServiceContext struct {
      Config config.Config
      // Phase 8 adds: ClickModel model.ClickModel
      // Phase 9 adds: KafkaConsumer (configured elsewhere)
  }

  func NewServiceContext(c config.Config) *ServiceContext {
      return &ServiceContext{
          Config: c,
      }
  }
  ```

  Add comments about future phases if they're not already present.

  **Step 3: Implement stub logic for GetClickCount.**

  Edit `services/analytics-rpc/internal/logic/getclickcountlogic.go`:

  ```go
  func (l *GetClickCountLogic) GetClickCount(in *analytics.GetClickCountRequest) (*analytics.GetClickCountResponse, error) {
      logx.WithContext(l.ctx).Infow("get click count",
          logx.Field("short_code", in.ShortCode),
      )

      // Phase 7 stub: return fake click count
      // Phase 8: Query PostgreSQL for actual click count
      return &analytics.GetClickCountResponse{
          ShortCode:   in.ShortCode,
          TotalClicks: 42,
      }, nil
  }
  ```

  **Step 4: Update Makefile with Analytics service targets.**

  Add to Makefile:
  ```makefile
  .PHONY: run-analytics gen-analytics run-all

  run-analytics: ## Run Analytics RPC service
  	go run services/analytics-rpc/analytics.go -f services/analytics-rpc/etc/analytics-rpc.yaml

  gen-analytics: ## Regenerate Analytics RPC from .proto spec
  	cd services/analytics-rpc && goctl rpc protoc analytics.proto --go_out=. --go-grpc_out=. --zrpc_out=. --style gozero

  run-all: ## Run both services (URL API + Analytics RPC)
  	@echo "Starting Analytics RPC on :8081..."
  	@go run services/analytics-rpc/analytics.go -f services/analytics-rpc/etc/analytics-rpc.yaml &
  	@echo "Starting URL API on :8080..."
  	@go run services/url-api/url.go -f services/url-api/etc/url-api.yaml
  ```

  **Step 5: Verify the service starts and responds to gRPC calls.**

  ```bash
  # Build check
  go build ./services/analytics-rpc/...

  # Start service in background
  go run services/analytics-rpc/analytics.go -f services/analytics-rpc/etc/analytics-rpc.yaml &
  sleep 2

  # Test gRPC endpoint using grpcurl (if available) or goctl rpc client
  # Option A: Use grpcurl
  grpcurl -plaintext -d '{"short_code":"test123"}' localhost:8081 analytics.Analytics/GetClickCount

  # Option B: If grpcurl not available, just verify the service starts and listens
  # The service starting without errors and listening on :8081 proves the gRPC server is configured
  # Test with a simple Go program or skip network test (build success is sufficient for Phase 7)

  # Kill background process
  kill %1
  ```

  If grpcurl is not installed, the build + start verification is sufficient. The service will be properly tested when URL service calls it via the generated client in Phase 9.

  **Step 6: Verify the generated client is importable.**

  Create a quick build check to confirm the client package compiles. The client will be used by URL service in Phase 9:
  ```bash
  go build ./services/analytics-rpc/analyticsclient/...
  ```
  </action>
  <verify>
  - `go build ./services/analytics-rpc/...` compiles without errors
  - `go build ./services/analytics-rpc/analyticsclient/...` compiles (client importable)
  - Start service: `go run services/analytics-rpc/analytics.go -f services/analytics-rpc/etc/analytics-rpc.yaml` starts without errors
  - Console logs show service name and port on startup
  - If grpcurl available: `grpcurl -plaintext -d '{"short_code":"test123"}' localhost:8081 analytics.Analytics/GetClickCount` returns response with total_clicks: 42
  - Makefile targets work: `make run-analytics` starts the service
  </verify>
  <done>Analytics RPC service starts on port 8081 with gRPC server. GetClickCount returns stub response (total_clicks: 42). Generated client package compiles and is importable. Configuration loaded from YAML with console logging enabled. Makefile targets added for run and regeneration.</done>
</task>

</tasks>

<verification>
1. `services/analytics-rpc/analytics.proto` defines GetClickCount RPC
2. `go build ./services/analytics-rpc/...` compiles
3. `go build ./services/analytics-rpc/analyticsclient/...` compiles (client package)
4. Service starts: `go run services/analytics-rpc/analytics.go -f services/analytics-rpc/etc/analytics-rpc.yaml`
5. Service logs show "analytics-rpc" service name and listening port
6. `make run-analytics` works
7. `make run-all` starts both URL API and Analytics RPC services
</verification>

<success_criteria>
- analytics.proto defines GetClickCount RPC with request/response messages
- goctl rpc protoc generates server, client, logic, config, and proto stubs
- Analytics RPC service starts on port 8081 and accepts gRPC connections
- GetClickCount returns stub response (short_code echoed, total_clicks: 42)
- Generated client package at analyticsclient/ is importable by other services
- Config loaded from YAML (port 8081, console logging)
- ServiceContext has config only (Phase 7 stub)
- Makefile targets: run-analytics, gen-analytics, run-all
</success_criteria>

<output>
After completion, create `.planning/phases/07-framework-foundation/07-03-SUMMARY.md`
</output>
