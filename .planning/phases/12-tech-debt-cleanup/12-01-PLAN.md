---
phase: 12-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/url-api/model/urlsmodel.go
  - services/url-api/model/mock_urlsmodel.go
  - test/integration/shorten_test.go
  - docker-compose.yml
autonomous: true
requirements:
  - DEBT-01
  - DEBT-03

must_haves:
  truths:
    - "IncrementClickCount method does not exist in the codebase"
    - "go build ./... compiles without errors after dead code removal"
    - "Kafka click-events topic has explicit retention settings preventing unbounded growth"
  artifacts:
    - path: "services/url-api/model/urlsmodel.go"
      provides: "UrlsModel interface without IncrementClickCount"
      contains: "ListWithPagination"
    - path: "services/url-api/model/mock_urlsmodel.go"
      provides: "MockUrlsModel without IncrementClickCount"
      contains: "ListWithPaginationFunc"
    - path: "docker-compose.yml"
      provides: "Kafka retention configuration"
      contains: "KAFKA_LOG_RETENTION_HOURS"
  key_links:
    - from: "services/url-api/model/mock_urlsmodel.go"
      to: "services/url-api/model/urlsmodel.go"
      via: "var _ UrlsModel = (*MockUrlsModel)(nil)"
      pattern: "var _ UrlsModel"
---

<objective>
Remove the dead IncrementClickCount method from the url-api model layer and configure Kafka topic retention in Docker Compose.

Purpose: Clean up dead code left from Phase 9 messaging migration and prevent Kafka topic from growing unboundedly in development/production.
Output: Cleaned urlsmodel.go/mock without IncrementClickCount, updated integration test, docker-compose.yml with Kafka retention settings.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-tech-debt-cleanup/12-RESEARCH.md
@services/url-api/model/urlsmodel.go
@services/url-api/model/mock_urlsmodel.go
@test/integration/shorten_test.go
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove dead IncrementClickCount method from urlsmodel and mock</name>
  <files>
    services/url-api/model/urlsmodel.go
    services/url-api/model/mock_urlsmodel.go
    test/integration/shorten_test.go
  </files>
  <action>
    Remove IncrementClickCount from three files simultaneously (interface, implementation, mock, and integration test):

    1. **services/url-api/model/urlsmodel.go**:
       - Remove `IncrementClickCount(ctx context.Context, shortCode string) error` from the `UrlsModel` interface declaration (line 20)
       - Remove the entire `IncrementClickCount` method implementation (lines 100-106, the `func (m *customUrlsModel) IncrementClickCount(...)` block)
       - Remove the comment above it (line 100: "// IncrementClickCount atomically increments...")

    2. **services/url-api/model/mock_urlsmodel.go**:
       - Remove `IncrementClickCountFunc func(ctx context.Context, shortCode string) error` field from MockUrlsModel struct (line 18)
       - Remove the `func (m *MockUrlsModel) IncrementClickCount(...)` method (lines 67-72)

    3. **test/integration/shorten_test.go**:
       - Remove the "Test: Increment click count" block (lines 78-84):
         ```
         // Test: Increment click count
         err = urlModel.IncrementClickCount(ctx, "testcode")
         require.NoError(t, err)

         updated, err := urlModel.FindOneByShortCode(ctx, "testcode")
         require.NoError(t, err)
         assert.Equal(t, int64(1), updated.ClickCount)
         ```

    Do NOT edit:
    - `urlsmodel_gen.go` — generated file, ClickCount field stays
    - Migration files — click_count column stays in the database

    After edits, verify compile-time interface assertion `var _ UrlsModel = (*MockUrlsModel)(nil)` still compiles (it should, since both interface and mock have IncrementClickCount removed).
  </action>
  <verify>
    Run `go build ./...` from the project root — must pass with zero errors.
    Run `grep -r "IncrementClickCount" services/ test/` — must return zero matches (only _gen.go fields referencing click_count column are allowed, but IncrementClickCount as a method name should not appear).
  </verify>
  <done>IncrementClickCount method, its mock, and its integration test are completely removed. `go build ./...` passes. No references to IncrementClickCount remain in non-generated code.</done>
</task>

<task type="auto">
  <name>Task 2: Configure Kafka topic retention in docker-compose.yml</name>
  <files>docker-compose.yml</files>
  <action>
    Add three Kafka retention environment variables to the `kafka` service in `docker-compose.yml`, after the existing `KAFKA_LOG_DIRS` line:

    ```yaml
    KAFKA_LOG_RETENTION_HOURS: "24"
    KAFKA_LOG_RETENTION_BYTES: "1073741824"
    KAFKA_LOG_SEGMENT_BYTES: "104857600"
    ```

    These settings:
    - `KAFKA_LOG_RETENTION_HOURS: "24"` — delete segments older than 24 hours (default is 168 / 7 days)
    - `KAFKA_LOG_RETENTION_BYTES: "1073741824"` — delete segments when partition exceeds 1GB (default is -1 / no limit)
    - `KAFKA_LOG_SEGMENT_BYTES: "104857600"` — 100MB segment size for more granular cleanup (default is 1GB)

    The env var naming convention follows the existing pattern in the file (e.g., `KAFKA_NODE_ID` maps to `node.id`). These broker-level defaults apply to auto-created topics like `click-events`.
  </action>
  <verify>
    Run `docker compose config` from the project root — the output must show the three new env vars under the kafka service.
    Alternatively, visually verify `docker-compose.yml` contains `KAFKA_LOG_RETENTION_HOURS`, `KAFKA_LOG_RETENTION_BYTES`, and `KAFKA_LOG_SEGMENT_BYTES` in the kafka service environment block.
  </verify>
  <done>Kafka click-events topic has explicit retention settings (24h time, 1GB size, 100MB segments) in Docker Compose. Topic will not grow unboundedly.</done>
</task>

</tasks>

<verification>
1. `go build ./...` passes (no compile errors after dead code removal)
2. `grep -r "IncrementClickCount" services/ test/` returns no matches in non-generated files
3. `docker compose config` shows KAFKA_LOG_RETENTION_HOURS, KAFKA_LOG_RETENTION_BYTES, KAFKA_LOG_SEGMENT_BYTES
</verification>

<success_criteria>
- IncrementClickCount method is completely removed from interface, implementation, mock, and integration test
- Codebase compiles cleanly with `go build ./...`
- docker-compose.yml contains Kafka retention configuration preventing unbounded topic growth
</success_criteria>

<output>
After completion, create `.planning/phases/12-tech-debt-cleanup/12-01-SUMMARY.md`
</output>
