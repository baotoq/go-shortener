---
phase: 05-production-readiness
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - internal/analytics/usecase/analytics_service_test.go
  - internal/urlservice/delivery/http/handler_test.go
  - internal/analytics/delivery/http/handler_test.go
autonomous: true

must_haves:
  truths:
    - "Analytics Service usecase layer has unit tests for enrichment, summary, detail, and delete"
    - "URL Service handler tests verify HTTP status codes, JSON responses, and error handling"
    - "Analytics Service handler tests verify event processing, query endpoints, and error paths"
    - "All tests use generated mocks from Plan 01"
  artifacts:
    - path: "internal/analytics/usecase/analytics_service_test.go"
      provides: "Unit tests for AnalyticsService business logic"
      min_lines: 80
    - path: "internal/urlservice/delivery/http/handler_test.go"
      provides: "HTTP handler unit tests for URL Service"
      min_lines: 100
    - path: "internal/analytics/delivery/http/handler_test.go"
      provides: "HTTP handler unit tests for Analytics Service"
      min_lines: 80
  key_links:
    - from: "internal/analytics/usecase/analytics_service_test.go"
      to: "internal/analytics/usecase/mocks"
      via: "import mocks package"
      pattern: "mocks\\.NewMock"
    - from: "internal/urlservice/delivery/http/handler_test.go"
      to: "internal/urlservice/usecase"
      via: "creates real URLService with mocked repo"
      pattern: "usecase\\.NewURLService"
---

<objective>
Write unit tests for the Analytics Service usecase layer and HTTP handler layers for both services.

Purpose: Complete the unit test coverage across all layers (usecase + handler) for both services. Handler tests verify HTTP routing, request parsing, response formatting, and error handling. Analytics usecase tests verify enrichment wiring, breakdown percentage calculation, and click detail pagination.

Output: Three test files covering analytics usecase, URL Service handlers, and Analytics Service handlers.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-production-readiness/05-RESEARCH.md
@.planning/phases/05-production-readiness/05-01-SUMMARY.md

@internal/analytics/usecase/analytics_service.go
@internal/analytics/usecase/click_repository.go
@internal/urlservice/delivery/http/handler.go
@internal/urlservice/delivery/http/router.go
@internal/urlservice/delivery/http/response.go
@internal/analytics/delivery/http/handler.go
@internal/analytics/delivery/http/router.go
@internal/analytics/delivery/http/response.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analytics Service usecase unit tests</name>
  <files>
    internal/analytics/usecase/analytics_service_test.go
  </files>
  <action>
    Write scenario-based unit tests for `AnalyticsService` using mocks from Plan 01.

    Test scenarios:

    **RecordEnrichedClick:**
    - `TestRecordEnrichedClick_EnrichesAndStores` -- verifies GeoIP, UA, Referer enrichment called, InsertClick called with enriched values
    - `TestRecordEnrichedClick_RepositoryError_ReturnsError` -- repo.InsertClick fails

    **GetClickCount:**
    - `TestGetClickCount_ReturnsCount` -- repo returns count
    - `TestGetClickCount_NoClicks_ReturnsZero` -- repo returns 0

    **GetAnalyticsSummary:**
    - `TestGetAnalyticsSummary_ReturnsBreakdowns` -- all 4 repo calls succeed, percentages calculated correctly
    - `TestGetAnalyticsSummary_ZeroClicks_ReturnsEmptyBreakdowns` -- total=0, empty breakdown items
    - `TestGetAnalyticsSummary_CountError_ReturnsError` -- repo.CountInRange fails

    **GetClickDetails:**
    - `TestGetClickDetails_ReturnsPaginated` -- repo returns clicks with cursor
    - `TestGetClickDetails_InvalidLimit_DefaultsTo20` -- limit=0 or limit=200 both default to 20
    - `TestGetClickDetails_RepositoryError_ReturnsError`

    **DeleteClickData:**
    - `TestDeleteClickData_Success` -- repo.DeleteByShortCode called
    - `TestDeleteClickData_Error_ReturnsError`

    **convertToBreakdownItems (tested indirectly through GetAnalyticsSummary):**
    - Verify percentage calculation: 42 out of 100 = 42.0%
    - Verify zero total returns empty slice

    Mock setup:
    ```go
    mockRepo := mocks.NewMockClickRepository(t)
    mockGeoIP := mocks.NewMockGeoIPResolver(t)
    mockDevice := mocks.NewMockDeviceDetector(t)
    mockReferer := mocks.NewMockRefererClassifier(t)
    service := usecase.NewAnalyticsService(mockRepo, mockGeoIP, mockDevice, mockReferer)
    ```
  </action>
  <verify>
    - `go test ./internal/analytics/usecase/ -v` -- all tests pass
    - `go test ./internal/analytics/usecase/ -cover` -- coverage >80%
  </verify>
  <done>Analytics Service usecase has 10+ scenario-based unit tests covering all public methods with >80% coverage</done>
</task>

<task type="auto">
  <name>Task 2: URL Service and Analytics Service HTTP handler unit tests</name>
  <files>
    internal/urlservice/delivery/http/handler_test.go
    internal/analytics/delivery/http/handler_test.go
  </files>
  <action>
    Write handler-level unit tests for both services using `httptest.NewRecorder()` and `httptest.NewRequest()`.

    **URL Service handler tests (`handler_test.go`):**

    The handler depends on `*usecase.URLService` (concrete type, not interface), so tests must create a real URLService with mocked repository and Dapr client.

    Test scenarios:

    **CreateShortURL (POST /api/v1/urls):**
    - `TestCreateShortURL_ValidRequest_Returns201` -- valid JSON, 201 with short_url in response
    - `TestCreateShortURL_InvalidJSON_Returns400` -- malformed body, 400 problem detail
    - `TestCreateShortURL_EmptyURL_Returns400` -- empty original_url field
    - `TestCreateShortURL_InvalidURL_Returns400` -- ftp:// scheme
    - `TestCreateShortURL_ServerError_Returns500` -- repo returns unexpected error

    **Redirect (GET /{code}):**
    - `TestRedirect_ExistingCode_Returns302` -- 302 with Location header
    - `TestRedirect_NotFound_Returns404` -- 404 problem detail

    **ListLinks (GET /api/v1/links):**
    - `TestListLinks_DefaultParams_Returns200` -- default page=1, per_page=20
    - `TestListLinks_WithPagination_Returns200` -- page=2, per_page=5
    - `TestListLinks_ServerError_Returns500`

    **GetLinkDetail (GET /api/v1/links/{code}):**
    - `TestGetLinkDetail_Exists_Returns200` -- link found with click count
    - `TestGetLinkDetail_NotFound_Returns404`

    **DeleteLink (DELETE /api/v1/links/{code}):**
    - `TestDeleteLink_Success_Returns204` -- 204 No Content
    - `TestDeleteLink_Error_Returns500`

    Test helper pattern:
    ```go
    func setupTestHandler(t *testing.T) (*Handler, *mocks.MockURLRepository) {
      mockRepo := mocks.NewMockURLRepository(t)
      service := usecase.NewURLService(mockRepo, nil, zap.NewNop(), "http://localhost:8080")
      handler := NewHandler(service, "http://localhost:8080", nil, zap.NewNop())
      return handler, mockRepo
    }
    ```

    For routes using chi.URLParam, use chi.NewRouter() to set up routes properly in tests so URL params are extracted correctly:
    ```go
    r := chi.NewRouter()
    r.Get("/{code}", handler.Redirect)
    r.ServeHTTP(rr, req)
    ```

    Assert response status codes, Content-Type headers, and JSON body structure.

    **Analytics Service handler tests (`handler_test.go`):**

    The handler depends on `*usecase.AnalyticsService` (concrete type), so create real service with all mocked dependencies.

    Test scenarios:

    **GetClickCount (GET /analytics/{code}):**
    - `TestGetClickCount_ReturnsCount` -- 200 with total_clicks
    - `TestGetClickCount_ZeroClicks_Returns200WithZero` -- per decision: 0 clicks = 200, not 404
    - `TestGetClickCount_Error_Returns500`

    **GetAnalyticsSummary (GET /analytics/{code}/summary):**
    - `TestGetAnalyticsSummary_Returns200` -- summary with breakdowns
    - `TestGetAnalyticsSummary_WithTimeRange_PassesParams` -- from/to query params parsed
    - `TestGetAnalyticsSummary_InvalidDateFormat_Returns400` -- bad from/to format

    **GetClickDetails (GET /analytics/{code}/clicks):**
    - `TestGetClickDetails_Returns200` -- paginated clicks
    - `TestGetClickDetails_WithCursor_ParsesCursor` -- base64 cursor decoded
    - `TestGetClickDetails_InvalidCursor_Returns400`

    **HandleClickEvent (POST /events/click):**
    - `TestHandleClickEvent_ValidEvent_Returns200` -- CloudEvent unwrapped, enriched, stored
    - `TestHandleClickEvent_MalformedJSON_Returns200` -- malformed acknowledged (no retry)
    - `TestHandleClickEvent_ProcessingError_Returns200` -- per decision: always 200

    **HandleLinkDeleted (POST /events/link-deleted):**
    - `TestHandleLinkDeleted_ValidEvent_DeletesData` -- 200, DeleteClickData called
    - `TestHandleLinkDeleted_MalformedEvent_Returns200` -- acknowledged without processing

    Test helper pattern:
    ```go
    func setupTestAnalyticsHandler(t *testing.T) (*Handler, *mocks.MockClickRepository, ...) {
      mockRepo := mocks.NewMockClickRepository(t)
      mockGeoIP := mocks.NewMockGeoIPResolver(t)
      mockDevice := mocks.NewMockDeviceDetector(t)
      mockReferer := mocks.NewMockRefererClassifier(t)
      service := usecase.NewAnalyticsService(mockRepo, mockGeoIP, mockDevice, mockReferer)
      handler := NewHandler(service, zap.NewNop())
      return handler, mockRepo, mockGeoIP, mockDevice, mockReferer
    }
    ```

    For click event tests, wrap test data in CloudEvent format:
    ```go
    body := map[string]interface{}{
      "data": events.ClickEvent{ShortCode: "abc123", Timestamp: time.Now(), ...},
    }
    ```

    Use chi.NewRouter() for URL parameter extraction (same pattern as URL Service handler tests).
  </action>
  <verify>
    - `go test ./internal/urlservice/delivery/http/ -v` -- all tests pass
    - `go test ./internal/analytics/delivery/http/ -v` -- all tests pass
    - `go test ./internal/urlservice/delivery/http/ -cover` -- coverage on handler.go >80%
    - `go test ./internal/analytics/delivery/http/ -cover` -- coverage on handler.go >80%
  </verify>
  <done>Both handler packages have 13+ unit tests each covering all endpoints with correct status codes, JSON responses, error handling, and CloudEvent processing</done>
</task>

</tasks>

<verification>
- `go test ./internal/analytics/usecase/ -v -count=1` -- all pass
- `go test ./internal/urlservice/delivery/http/ -v -count=1` -- all pass
- `go test ./internal/analytics/delivery/http/ -v -count=1` -- all pass
- `go test ./... -cover` -- all tested packages >80%
</verification>

<success_criteria>
- Analytics usecase has >80% coverage
- Both handler packages have >80% coverage on handler.go
- All test files follow scenario-based style (setup/act/assert)
- Event handler tests verify CloudEvent unwrapping
- Zero clicks returns 200 (not 404) per project decision
</success_criteria>

<output>
After completion, create `.planning/phases/05-production-readiness/05-02-SUMMARY.md`
</output>
