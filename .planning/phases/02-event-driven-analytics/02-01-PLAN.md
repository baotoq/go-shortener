---
phase: 02-event-driven-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/urlservice/delivery/http/handler.go
  - internal/urlservice/delivery/http/middleware.go
  - internal/urlservice/delivery/http/response.go
  - internal/urlservice/delivery/http/router.go
  - internal/urlservice/usecase/url_repository.go
  - internal/urlservice/usecase/url_service.go
  - internal/urlservice/repository/sqlite/url_repository.go
  - internal/urlservice/repository/sqlite/sqlc/db.go
  - internal/urlservice/repository/sqlite/sqlc/models.go
  - internal/urlservice/repository/sqlite/sqlc/querier.go
  - internal/urlservice/repository/sqlite/sqlc/query.sql.go
  - internal/urlservice/domain/url.go
  - internal/urlservice/domain/errors.go
  - internal/urlservice/database/database.go
  - internal/urlservice/database/migrations/000001_create_urls.up.sql
  - internal/urlservice/database/migrations/000001_create_urls.down.sql
  - internal/shared/events/click_event.go
  - dapr/components/pubsub.yaml
  - dapr.yaml
  - Makefile
  - cmd/url-service/main.go
  - sqlc.yaml
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "Existing URL Service builds and runs from the new directory structure"
    - "All existing API endpoints (POST /api/v1/urls, GET /{code}, GET /api/v1/urls/{code}) work identically after restructure"
    - "Shared ClickEvent struct is importable by both url-service and analytics-service code"
    - "Dapr in-memory pub/sub component file exists and is valid YAML"
    - "Multi-app run template (dapr.yaml) configures both services with unique ports"
    - "Makefile provides run targets for both services"
  artifacts:
    - path: "internal/urlservice/delivery/http/handler.go"
      provides: "URL Service HTTP handlers (moved from internal/delivery/http/)"
    - path: "internal/shared/events/click_event.go"
      provides: "Shared ClickEvent struct with ShortCode and Timestamp fields"
      exports: ["ClickEvent"]
    - path: "dapr/components/pubsub.yaml"
      provides: "Dapr in-memory pub/sub component configuration"
      contains: "pubsub.in-memory"
    - path: "dapr.yaml"
      provides: "Multi-app run template for both services"
      contains: "analytics-service"
    - path: "Makefile"
      provides: "Run targets for services"
      contains: "run-url"
    - path: "cmd/url-service/main.go"
      provides: "Updated URL Service entry point with new import paths"
  key_links:
    - from: "cmd/url-service/main.go"
      to: "internal/urlservice/"
      via: "import paths"
      pattern: "go-shortener/internal/urlservice"
    - from: "internal/shared/events/click_event.go"
      to: "both cmd/ binaries"
      via: "shared import"
      pattern: "go-shortener/internal/shared/events"
---

<objective>
Restructure the repository for multi-service architecture, add Dapr pub/sub infrastructure, and create shared event types.

Purpose: Phase 2 introduces a second service (Analytics). The repo must be reorganized to namespace URL Service code under `internal/urlservice/` and establish shared infrastructure (Dapr components, multi-app config, Makefile, shared event types) that both services will use.

Output: Restructured repository where URL Service builds and runs from new paths, plus Dapr config files, Makefile, and shared ClickEvent type ready for Plans 02 and 03.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-event-driven-analytics/02-CONTEXT.md
@.planning/phases/02-event-driven-analytics/02-RESEARCH.md
@.planning/phases/01-foundation-url-service-core/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure URL Service code into internal/urlservice/ namespace</name>
  <files>
    internal/urlservice/delivery/http/handler.go
    internal/urlservice/delivery/http/middleware.go
    internal/urlservice/delivery/http/response.go
    internal/urlservice/delivery/http/router.go
    internal/urlservice/usecase/url_repository.go
    internal/urlservice/usecase/url_service.go
    internal/urlservice/repository/sqlite/url_repository.go
    internal/urlservice/repository/sqlite/sqlc/db.go
    internal/urlservice/repository/sqlite/sqlc/models.go
    internal/urlservice/repository/sqlite/sqlc/querier.go
    internal/urlservice/repository/sqlite/sqlc/query.sql.go
    internal/urlservice/domain/url.go
    internal/urlservice/domain/errors.go
    internal/urlservice/database/database.go
    internal/urlservice/database/migrations/000001_create_urls.up.sql
    internal/urlservice/database/migrations/000001_create_urls.down.sql
    cmd/url-service/main.go
    sqlc.yaml
  </files>
  <action>
    Move ALL existing URL Service code from `internal/` into `internal/urlservice/` namespace. This is a directory restructure — the code stays the same, only import paths change.

    Steps:
    1. Create the new directory structure:
       - `internal/urlservice/delivery/http/`
       - `internal/urlservice/usecase/`
       - `internal/urlservice/repository/sqlite/sqlc/`
       - `internal/urlservice/domain/`
       - `internal/urlservice/database/migrations/`

    2. Move files (preserving content, updating ONLY import paths):
       - `internal/delivery/http/*.go` -> `internal/urlservice/delivery/http/*.go`
       - `internal/usecase/*.go` -> `internal/urlservice/usecase/*.go`
       - `internal/repository/sqlite/*.go` -> `internal/urlservice/repository/sqlite/*.go`
       - `internal/repository/sqlite/sqlc/*.go` -> `internal/urlservice/repository/sqlite/sqlc/*.go`
       - `internal/domain/*.go` -> `internal/urlservice/domain/*.go`
       - `internal/database/database.go` -> `internal/urlservice/database/database.go`
       - `internal/database/migrations/*.sql` -> `internal/urlservice/database/migrations/*.sql`

    3. Update ALL import paths in moved files. Every occurrence of:
       - `go-shortener/internal/delivery/http` -> `go-shortener/internal/urlservice/delivery/http`
       - `go-shortener/internal/usecase` -> `go-shortener/internal/urlservice/usecase`
       - `go-shortener/internal/repository/sqlite` -> `go-shortener/internal/urlservice/repository/sqlite`
       - `go-shortener/internal/domain` -> `go-shortener/internal/urlservice/domain`
       - `go-shortener/internal/database` -> `go-shortener/internal/urlservice/database`

    4. Update `cmd/url-service/main.go` import paths to use `go-shortener/internal/urlservice/...`

    5. Update `sqlc.yaml` output path from `internal/repository/sqlite/sqlc` to `internal/urlservice/repository/sqlite/sqlc`

    6. Delete the OLD directories after confirming new ones work:
       - `internal/delivery/`
       - `internal/usecase/`
       - `internal/repository/`
       - `internal/domain/`
       - `internal/database/`

    NOTE: `pkg/problemdetails/` stays at `pkg/` — it's shared across services.
    NOTE: `db/schema.sql` and `db/query.sql` stay where they are — sqlc reads them at code-gen time, not runtime.

    Do NOT change any business logic. Only paths and imports change.
  </action>
  <verify>
    Run `go build ./cmd/url-service/` — must compile successfully.
    Run `go vet ./...` — must pass with no issues.
    Verify old directories are removed: `ls internal/delivery internal/usecase internal/repository internal/domain internal/database` should all fail with "No such file or directory".
  </verify>
  <done>URL Service builds from `internal/urlservice/` namespace. All old directories removed. No business logic changes.</done>
</task>

<task type="auto">
  <name>Task 2: Add Dapr infrastructure, shared event types, Makefile, and install Dapr SDK</name>
  <files>
    internal/shared/events/click_event.go
    dapr/components/pubsub.yaml
    dapr.yaml
    Makefile
    go.mod
    go.sum
  </files>
  <action>
    Create shared event types, Dapr component configuration, multi-app run template, and Makefile.

    1. Install Dapr Go SDK:
       ```
       go get github.com/dapr/go-sdk
       ```

    2. Create `internal/shared/events/click_event.go`:
       ```go
       package events

       import "time"

       // ClickEvent represents a URL redirect click for analytics tracking.
       // Published by URL Service, consumed by Analytics Service.
       type ClickEvent struct {
           ShortCode string    `json:"short_code"`
           Timestamp time.Time `json:"timestamp"`
       }
       ```
       Per user decision: minimal payload — short code + timestamp ONLY. No IP, User-Agent, or Referer.

    3. Create `dapr/components/pubsub.yaml` — in-memory pub/sub per user decision:
       ```yaml
       apiVersion: dapr.io/v1alpha1
       kind: Component
       metadata:
         name: pubsub
       spec:
         type: pubsub.in-memory
         version: v1
         metadata: []
       ```

    4. Create `dapr.yaml` — multi-app run template per research recommendation:
       ```yaml
       version: 1
       common:
         resourcesPath: ./dapr/components
       apps:
         - appID: url-service
           appDirPath: ./
           appPort: 8080
           daprHTTPPort: 3500
           daprGRPCPort: 50001
           command: ["go", "run", "./cmd/url-service"]

         - appID: analytics-service
           appDirPath: ./
           appPort: 8081
           daprHTTPPort: 3501
           daprGRPCPort: 50002
           command: ["go", "run", "./cmd/analytics-service"]
       ```
       Port assignments per research: URL Service 8080/3500/50001, Analytics Service 8081/3501/50002.

    5. Create `Makefile` with run targets per user decision:
       ```makefile
       .PHONY: run-url run-analytics run-all build

       # Run URL Service with Dapr sidecar
       run-url:
       	dapr run --app-id url-service --app-port 8080 --dapr-http-port 3500 --dapr-grpc-port 50001 --resources-path ./dapr/components -- go run ./cmd/url-service

       # Run Analytics Service with Dapr sidecar
       run-analytics:
       	dapr run --app-id analytics-service --app-port 8081 --dapr-http-port 3501 --dapr-grpc-port 50002 --resources-path ./dapr/components -- go run ./cmd/analytics-service

       # Run both services using Dapr multi-app run
       run-all:
       	dapr run -f dapr.yaml

       # Build both binaries
       build:
       	go build -o bin/url-service ./cmd/url-service
       	go build -o bin/analytics-service ./cmd/analytics-service
       ```
       Use tabs for Makefile indentation (critical — spaces will break Make).

    6. Verify `go build ./cmd/url-service/` still compiles after adding Dapr SDK dependency.
  </action>
  <verify>
    Run `go build ./cmd/url-service/` — must compile.
    Run `go vet ./internal/shared/...` — must pass.
    Verify files exist: `dapr/components/pubsub.yaml`, `dapr.yaml`, `Makefile`, `internal/shared/events/click_event.go`.
  </verify>
  <done>Dapr SDK installed. Shared ClickEvent type defined. Dapr component, multi-app config, and Makefile created. URL Service still builds.</done>
</task>

</tasks>

<verification>
1. `go build ./cmd/url-service/` compiles with new import paths
2. `go vet ./...` passes (may warn about analytics-service cmd not existing yet — that's OK)
3. Old `internal/delivery/`, `internal/usecase/`, `internal/repository/`, `internal/domain/`, `internal/database/` directories are gone
4. `internal/urlservice/` contains all URL Service code
5. `internal/shared/events/click_event.go` exists with ClickEvent struct
6. `dapr/components/pubsub.yaml` is valid YAML with `pubsub.in-memory` type
7. `dapr.yaml` configures both services with distinct ports
8. `Makefile` has `run-url`, `run-analytics`, `run-all` targets
</verification>

<success_criteria>
- URL Service compiles and all original behavior is preserved (same routes, same logic)
- Repository restructured with `internal/urlservice/` namespace
- Dapr infrastructure files ready for both services
- Shared event type importable by both services
- Makefile provides convenient run commands
</success_criteria>

<output>
After completion, create `.planning/phases/02-event-driven-analytics/02-01-SUMMARY.md`
</output>
