---
phase: 02-event-driven-analytics
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - internal/urlservice/delivery/http/handler.go
  - cmd/url-service/main.go
autonomous: true

must_haves:
  truths:
    - "Each redirect publishes a click event via Dapr pub/sub (fire-and-forget)"
    - "Click tracking failures do not prevent redirects from completing"
    - "Click event contains short_code and timestamp only"
  artifacts:
    - path: "internal/urlservice/delivery/http/handler.go"
      provides: "Redirect handler that publishes ClickEvent after redirect"
      contains: "PublishEvent"
    - path: "cmd/url-service/main.go"
      provides: "URL Service entry point with Dapr client initialization"
      contains: "dapr.NewClient"
  key_links:
    - from: "internal/urlservice/delivery/http/handler.go"
      to: "Dapr pub/sub"
      via: "dapr.Client.PublishEvent"
      pattern: "PublishEvent.*pubsub.*clicks"
    - from: "internal/urlservice/delivery/http/handler.go"
      to: "internal/shared/events/click_event.go"
      via: "import"
      pattern: "go-shortener/internal/shared/events"
---

<objective>
Add Dapr pub/sub click event publishing to URL Service redirect handler.

Purpose: When a user visits a short link, the redirect handler must publish a ClickEvent to the "clicks" topic via Dapr pub/sub. This is fire-and-forget: if publishing fails, log the error and proceed with the redirect. The redirect must never be blocked or delayed by analytics.

Output: Modified URL Service that publishes click events on every redirect while maintaining all existing behavior.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-event-driven-analytics/02-CONTEXT.md
@.planning/phases/02-event-driven-analytics/02-RESEARCH.md
@.planning/phases/02-event-driven-analytics/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Dapr client to URL Service and publish click events on redirect</name>
  <files>
    internal/urlservice/delivery/http/handler.go
    cmd/url-service/main.go
  </files>
  <action>
    Modify the URL Service to create a Dapr client at startup and publish click events during redirects.

    **1. Update `cmd/url-service/main.go`:**

    Add Dapr client creation after database initialization. The Dapr client is created once and shared (not per-request, which would be wasteful). Pass it to the Handler constructor.

    ```go
    import (
        dapr "github.com/dapr/go-sdk/client"
    )
    ```

    After the database setup, create the Dapr client:
    ```go
    // Create Dapr client for pub/sub publishing
    daprClient, err := dapr.NewClient()
    if err != nil {
        // Log warning but don't fail — service can run without Dapr for local dev
        logger.Warn("failed to create Dapr client, click tracking disabled", zap.Error(err))
    } else {
        defer daprClient.Close()
    }
    ```

    Pass `daprClient` to Handler (it may be nil if Dapr is unavailable):
    ```go
    handler := httpdelivery.NewHandler(service, baseURL, daprClient, logger)
    ```

    **2. Update `internal/urlservice/delivery/http/handler.go`:**

    Add daprClient and logger fields to Handler struct:
    ```go
    import (
        dapr "github.com/dapr/go-sdk/client"
        "go-shortener/internal/shared/events"
        "go.uber.org/zap"
    )

    type Handler struct {
        service    *usecase.URLService
        baseURL    string
        daprClient dapr.Client  // may be nil if Dapr unavailable
        logger     *zap.Logger
    }
    ```

    Update `NewHandler` to accept `daprClient dapr.Client` and `logger *zap.Logger` parameters.

    Modify the `Redirect` method. AFTER the successful `http.Redirect` call, publish the click event in a goroutine (fire-and-forget per user decision):

    ```go
    func (h *Handler) Redirect(w http.ResponseWriter, r *http.Request) {
        code := chi.URLParam(r, "code")

        url, err := h.service.GetByShortCode(r.Context(), code)
        if err != nil {
            // ... existing error handling unchanged ...
        }

        // Send redirect response FIRST
        http.Redirect(w, r, url.OriginalURL, http.StatusFound)

        // Fire-and-forget: publish click event after redirect
        // Per user decision: on failure, log error and continue
        if h.daprClient != nil {
            go h.publishClickEvent(code)
        }
    }
    ```

    Add private method for publishing:
    ```go
    const (
        pubsubName = "pubsub"
        topicName  = "clicks"
    )

    func (h *Handler) publishClickEvent(shortCode string) {
        event := events.ClickEvent{
            ShortCode: shortCode,
            Timestamp: time.Now().UTC(),
        }

        data, err := json.Marshal(event)
        if err != nil {
            h.logger.Error("failed to marshal click event",
                zap.String("short_code", shortCode),
                zap.Error(err),
            )
            return
        }

        ctx := context.Background()
        if err := h.daprClient.PublishEvent(ctx, pubsubName, topicName, data); err != nil {
            h.logger.Error("failed to publish click event",
                zap.String("short_code", shortCode),
                zap.Error(err),
            )
            // Click is lost, redirect already succeeded — per user decision
        }
    }
    ```

    Topic name "clicks" (plural noun per research recommendation).

    **3. Update `NewRouter` call in `router.go` if needed** — the router function receives Handler which now has extra fields, but the router function only calls handler methods, so it should not need changes. Verify.

    IMPORTANT: Do NOT change any existing error handling, response format, or routing. Only ADD the pub/sub publishing to the Redirect method. All other handlers (CreateShortURL, GetURLDetails) remain untouched.
  </action>
  <verify>
    Run `go build ./cmd/url-service/` — must compile successfully.
    Run `go vet ./...` — must pass.
    Verify handler.go contains `PublishEvent`, `publishClickEvent`, `events.ClickEvent`.
    Verify main.go contains `dapr.NewClient`.
  </verify>
  <done>
    URL Service redirect handler publishes ClickEvent to "clicks" topic via Dapr pub/sub.
    Dapr client created at startup (nil-safe if Dapr unavailable).
    Publishing is fire-and-forget in a goroutine — redirect is never blocked.
    All existing API behavior preserved.
  </done>
</task>

</tasks>

<verification>
1. `go build ./cmd/url-service/` compiles
2. `go vet ./...` passes
3. Redirect handler publishes to "clicks" topic after sending 302 response
4. Dapr client failure at startup logs warning but doesn't crash the service
5. Publish failure logs error but doesn't affect redirect response
6. ClickEvent payload is minimal: short_code + timestamp only
</verification>

<success_criteria>
- URL Service compiles with Dapr pub/sub integration
- Redirect handler publishes click events fire-and-forget
- Publishing failures are logged, never bubble up to the user
- All existing API endpoints work identically
</success_criteria>

<output>
After completion, create `.planning/phases/02-event-driven-analytics/02-02-SUMMARY.md`
</output>
