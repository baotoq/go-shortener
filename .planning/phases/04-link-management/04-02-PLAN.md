---
phase: 04-link-management
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - db/analytics_query.sql
  - db/analytics_schema.sql
  - internal/analytics/repository/sqlite/sqlc/models.go
  - internal/analytics/repository/sqlite/sqlc/querier.go
  - internal/analytics/repository/sqlite/sqlc/query.sql.go
  - internal/analytics/repository/sqlite/click_repository.go
  - internal/analytics/usecase/click_repository.go
  - internal/analytics/usecase/analytics_service.go
  - internal/analytics/delivery/http/handler.go
  - internal/analytics/delivery/http/router.go
autonomous: true

must_haves:
  truths:
    - "Analytics Service subscribes to link-deleted topic and deletes all click data for that short code"
    - "After link deletion, GET /analytics/{code} returns total_clicks: 0 for the deleted code"
    - "Malformed link-deleted events are acknowledged (200) to prevent infinite retries"
  artifacts:
    - path: "db/analytics_query.sql"
      provides: "DeleteClicksByShortCode sqlc query"
      contains: "DeleteClicksByShortCode"
    - path: "internal/analytics/usecase/click_repository.go"
      provides: "Extended ClickRepository with DeleteByShortCode method"
      contains: "DeleteByShortCode"
    - path: "internal/analytics/usecase/analytics_service.go"
      provides: "DeleteClickData service method"
      contains: "DeleteClickData"
    - path: "internal/analytics/delivery/http/handler.go"
      provides: "HandleLinkDeleted event handler"
      contains: "HandleLinkDeleted"
    - path: "internal/analytics/delivery/http/router.go"
      provides: "Subscription for link-deleted topic and route for /events/link-deleted"
      contains: "link-deleted"
  key_links:
    - from: "internal/analytics/delivery/http/handler.go"
      to: "internal/analytics/usecase/analytics_service.go"
      via: "analyticsService.DeleteClickData"
      pattern: "h\\.analyticsService\\.DeleteClickData"
    - from: "internal/analytics/delivery/http/router.go"
      to: "internal/analytics/delivery/http/handler.go"
      via: "Dapr subscription route for link-deleted"
      pattern: "link-deleted.*HandleLinkDeleted"
    - from: "internal/analytics/usecase/analytics_service.go"
      to: "internal/analytics/usecase/click_repository.go"
      via: "repo.DeleteByShortCode"
      pattern: "s\\.repo\\.DeleteByShortCode"
---

<objective>
Add link deletion cascade to Analytics Service — subscribe to "link-deleted" Dapr pub/sub topic and delete all click data for the deleted short code.

Purpose: When a user deletes a short link (via URL Service), all associated analytics data is cleaned up asynchronously, maintaining data consistency across services.

Output: Analytics Service handles link-deleted events, deletes click records, and acknowledges events reliably.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-link-management/04-RESEARCH.md
@.planning/phases/04-link-management/04-01-SUMMARY.md

# Key source files
@db/analytics_query.sql
@db/analytics_schema.sql
@sqlc.yaml
@internal/analytics/usecase/click_repository.go
@internal/analytics/usecase/analytics_service.go
@internal/analytics/repository/sqlite/click_repository.go
@internal/analytics/delivery/http/handler.go
@internal/analytics/delivery/http/router.go
@internal/shared/events/link_deleted_event.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DeleteByShortCode to Analytics Service with Dapr link-deleted subscription</name>
  <files>
    db/analytics_query.sql
    db/analytics_schema.sql
    internal/analytics/repository/sqlite/sqlc/* (regenerated)
    internal/analytics/repository/sqlite/click_repository.go
    internal/analytics/usecase/click_repository.go
    internal/analytics/usecase/analytics_service.go
    internal/analytics/delivery/http/handler.go
    internal/analytics/delivery/http/router.go
  </files>
  <action>
    **1. Add DeleteClicksByShortCode query to `db/analytics_query.sql`:**
    ```sql
    -- name: DeleteClicksByShortCode :exec
    DELETE FROM clicks WHERE short_code = ?;
    ```

    **2. Add the same query reference to `db/analytics_schema.sql`** if needed for sqlc schema consistency (no schema change, just ensure clicks table definition is present — it should be already).

    **3. Regenerate sqlc code:**
    ```bash
    sqlc generate
    ```
    This updates `internal/analytics/repository/sqlite/sqlc/` with the new DeleteClicksByShortCode function.

    **4. Extend `ClickRepository` interface** in `internal/analytics/usecase/click_repository.go`:
    Add method:
    ```go
    // DeleteByShortCode removes all click records for a short code.
    DeleteByShortCode(ctx context.Context, shortCode string) error
    ```

    **5. Implement `DeleteByShortCode`** in `internal/analytics/repository/sqlite/click_repository.go`:
    ```go
    func (r *ClickRepository) DeleteByShortCode(ctx context.Context, shortCode string) error {
        return r.queries.DeleteClicksByShortCode(ctx, shortCode)
    }
    ```
    Idempotent: deleting clicks for a non-existent short code returns nil (0 rows affected, no error).

    **6. Add `DeleteClickData` to `AnalyticsService`** in `internal/analytics/usecase/analytics_service.go`:
    ```go
    func (s *AnalyticsService) DeleteClickData(ctx context.Context, shortCode string) error {
        return s.repo.DeleteByShortCode(ctx, shortCode)
    }
    ```

    **7. Add `HandleLinkDeleted` handler** in `internal/analytics/delivery/http/handler.go`:

    Follow the exact same CloudEvent unwrapping pattern used in `HandleClickEvent`:
    ```go
    func (h *Handler) HandleLinkDeleted(w http.ResponseWriter, r *http.Request) {
        var cloudEvent struct {
            Data json.RawMessage `json:"data"`
        }

        if err := json.NewDecoder(r.Body).Decode(&cloudEvent); err != nil {
            h.logger.Error("failed to decode link deleted cloud event", zap.Error(err))
            w.WriteHeader(http.StatusOK) // Acknowledge malformed events
            return
        }

        var event events.LinkDeletedEvent
        if err := json.Unmarshal(cloudEvent.Data, &event); err != nil {
            h.logger.Error("failed to unmarshal link deleted event", zap.Error(err))
            w.WriteHeader(http.StatusOK) // Acknowledge malformed events
            return
        }

        if err := h.analyticsService.DeleteClickData(r.Context(), event.ShortCode); err != nil {
            h.logger.Error("failed to delete click data",
                zap.String("short_code", event.ShortCode),
                zap.Error(err),
            )
            // Acknowledge event to prevent infinite retries
        }

        h.logger.Info("deleted click data for link",
            zap.String("short_code", event.ShortCode),
        )

        w.WriteHeader(http.StatusOK)
    }
    ```

    Import `events` package: `"go-shortener/internal/shared/events"` (already imported for ClickEvent).

    **8. Update `router.go`** in `internal/analytics/delivery/http/`:

    Add new subscription entry to the `/dapr/subscribe` handler:
    ```go
    subscriptions := []map[string]string{
        {
            "pubsubname": "pubsub",
            "topic":      "clicks",
            "route":      "/events/click",
        },
        {
            "pubsubname": "pubsub",
            "topic":      "link-deleted",
            "route":      "/events/link-deleted",
        },
    }
    ```

    Add new route:
    ```go
    r.Post("/events/link-deleted", handler.HandleLinkDeleted)
    ```
  </action>
  <verify>
    1. `sqlc generate` completes without errors
    2. `go build ./cmd/analytics-service/` compiles successfully
    3. `go build ./cmd/url-service/` still compiles (no regressions)
    4. `go vet ./...` passes across entire codebase
    5. Start Analytics Service and verify `/dapr/subscribe` returns both "clicks" and "link-deleted" subscriptions
    6. Verify HandleLinkDeleted handler exists at POST /events/link-deleted
  </verify>
  <done>
    Analytics Service subscribes to "link-deleted" topic. When event received, all click data for that short code is deleted. Malformed events are acknowledged to prevent retries. Both services compile and pass vet.
  </done>
</task>

</tasks>

<verification>
1. `go build ./cmd/analytics-service/ && go build ./cmd/url-service/` — both compile
2. `go vet ./...` — no issues
3. Analytics Service /dapr/subscribe returns both "clicks" and "link-deleted" subscriptions
4. End-to-end: Create link → generate clicks → delete link → verify clicks cleaned up via Analytics API
</verification>

<success_criteria>
- Analytics Service subscribes to "link-deleted" topic via Dapr programmatic subscription
- HandleLinkDeleted handler deletes all click records for the short code
- Malformed events acknowledged with 200 (no infinite retries)
- Existing click event handling unchanged (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/04-link-management/04-02-SUMMARY.md`
</output>
