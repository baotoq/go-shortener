---
phase: 04-link-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - db/schema.sql
  - db/query.sql
  - internal/urlservice/database/migrations/000002_add_list_indexes.up.sql
  - internal/urlservice/database/migrations/000002_add_list_indexes.down.sql
  - internal/urlservice/repository/sqlite/sqlc/models.go
  - internal/urlservice/repository/sqlite/sqlc/querier.go
  - internal/urlservice/repository/sqlite/sqlc/query.sql.go
  - internal/urlservice/repository/sqlite/url_repository.go
  - internal/urlservice/usecase/url_repository.go
  - internal/urlservice/usecase/url_service.go
  - internal/urlservice/delivery/http/handler.go
  - internal/urlservice/delivery/http/response.go
  - internal/urlservice/delivery/http/router.go
  - internal/shared/events/link_deleted_event.go
  - cmd/url-service/main.go
autonomous: true

must_haves:
  truths:
    - "User can list all created short links via GET /api/v1/links with pagination metadata"
    - "User can filter links by date range and search by original URL substring"
    - "User can view a single link detail via GET /api/v1/links/:code with click count"
    - "User can delete a link via DELETE /api/v1/links/:code and receive 204"
    - "List response includes total_clicks per link fetched from Analytics Service"
    - "Delete publishes link.deleted event to Dapr pub/sub for Analytics cleanup"
  artifacts:
    - path: "internal/urlservice/database/migrations/000002_add_list_indexes.up.sql"
      provides: "SQLite indexes for created_at sorting and original_url search"
      contains: "CREATE INDEX"
    - path: "db/query.sql"
      provides: "ListURLs, CountURLs, DeleteURL sqlc queries"
      contains: "ListURLs"
    - path: "internal/urlservice/usecase/url_repository.go"
      provides: "Extended URLRepository interface with FindAll, Count, Delete"
      contains: "FindAll"
    - path: "internal/urlservice/usecase/url_service.go"
      provides: "ListLinks, GetLinkDetail, DeleteLink service methods"
      contains: "ListLinks"
    - path: "internal/urlservice/delivery/http/handler.go"
      provides: "ListLinks, GetLinkDetail, DeleteLink HTTP handlers"
      contains: "ListLinks"
    - path: "internal/urlservice/delivery/http/router.go"
      provides: "Routes for /api/v1/links endpoints"
      contains: "/api/v1/links"
    - path: "internal/shared/events/link_deleted_event.go"
      provides: "LinkDeletedEvent type for pub/sub"
      contains: "LinkDeletedEvent"
  key_links:
    - from: "internal/urlservice/delivery/http/handler.go"
      to: "internal/urlservice/usecase/url_service.go"
      via: "service.ListLinks, service.GetLinkDetail, service.DeleteLink"
      pattern: "h\\.service\\.ListLinks|h\\.service\\.GetLinkDetail|h\\.service\\.DeleteLink"
    - from: "internal/urlservice/usecase/url_service.go"
      to: "internal/urlservice/usecase/url_repository.go"
      via: "repo.FindAll, repo.Count, repo.Delete"
      pattern: "s\\.repo\\.FindAll|s\\.repo\\.Count|s\\.repo\\.Delete"
    - from: "internal/urlservice/usecase/url_service.go"
      to: "analytics-service via Dapr"
      via: "daprClient.InvokeMethod for click counts"
      pattern: "InvokeMethod"
    - from: "internal/urlservice/usecase/url_service.go"
      to: "internal/shared/events/link_deleted_event.go"
      via: "daprClient.PublishEvent for link deletion"
      pattern: "PublishEvent.*link-deleted"
---

<objective>
Add list, detail, and delete endpoints to URL Service with pagination, filtering, search, and click count enrichment via Dapr service invocation.

Purpose: Enable users to discover and manage their created short links through a complete CRUD API (minus update — links are immutable per user decision).

Output: Three new API endpoints (GET /api/v1/links, GET /api/v1/links/:code, DELETE /api/v1/links/:code), SQLite indexes for performance, and shared LinkDeletedEvent for Analytics cascade.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-link-management/04-RESEARCH.md

# Prior phase patterns needed for implementation
@.planning/phases/01-foundation-url-service-core/01-01-SUMMARY.md
@.planning/phases/01-foundation-url-service-core/01-02-SUMMARY.md
@.planning/phases/01-foundation-url-service-core/01-03-SUMMARY.md
@.planning/phases/02-event-driven-analytics/02-02-SUMMARY.md
@.planning/phases/02-event-driven-analytics/02-03-SUMMARY.md

# Key source files for understanding existing patterns
@db/query.sql
@db/schema.sql
@sqlc.yaml
@internal/urlservice/usecase/url_repository.go
@internal/urlservice/usecase/url_service.go
@internal/urlservice/repository/sqlite/url_repository.go
@internal/urlservice/delivery/http/handler.go
@internal/urlservice/delivery/http/router.go
@internal/urlservice/delivery/http/response.go
@internal/urlservice/domain/errors.go
@internal/shared/events/click_event.go
@cmd/url-service/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database indexes, sqlc queries, repository layer for list/count/delete</name>
  <files>
    db/schema.sql
    db/query.sql
    internal/urlservice/database/migrations/000002_add_list_indexes.up.sql
    internal/urlservice/database/migrations/000002_add_list_indexes.down.sql
    internal/urlservice/repository/sqlite/sqlc/* (regenerated)
    internal/urlservice/repository/sqlite/url_repository.go
    internal/urlservice/usecase/url_repository.go
  </files>
  <action>
    **1. Create migration 000002 for list indexes:**

    `internal/urlservice/database/migrations/000002_add_list_indexes.up.sql`:
    ```sql
    CREATE INDEX IF NOT EXISTS idx_urls_created_at ON urls(created_at DESC);
    CREATE INDEX IF NOT EXISTS idx_urls_original_url ON urls(original_url COLLATE NOCASE);
    ```

    `internal/urlservice/database/migrations/000002_add_list_indexes.down.sql`:
    ```sql
    DROP INDEX IF EXISTS idx_urls_created_at;
    DROP INDEX IF EXISTS idx_urls_original_url;
    ```

    **2. Add sqlc queries to `db/query.sql`** (append to existing queries):

    ```sql
    -- name: ListURLs :many
    SELECT * FROM urls
    WHERE
      (sqlc.narg('created_after') IS NULL OR created_at >= sqlc.narg('created_after'))
      AND (sqlc.narg('created_before') IS NULL OR created_at <= sqlc.narg('created_before'))
      AND (sqlc.narg('search') IS NULL OR original_url LIKE '%' || sqlc.narg('search') || '%')
    ORDER BY
      CASE WHEN sqlc.arg('sort_order') = 'asc' THEN created_at END ASC,
      CASE WHEN sqlc.arg('sort_order') = 'desc' THEN created_at END DESC,
      created_at DESC
    LIMIT sqlc.arg('query_limit') OFFSET sqlc.arg('query_offset');

    -- name: CountURLs :one
    SELECT COUNT(*) FROM urls
    WHERE
      (sqlc.narg('created_after') IS NULL OR created_at >= sqlc.narg('created_after'))
      AND (sqlc.narg('created_before') IS NULL OR created_at <= sqlc.narg('created_before'))
      AND (sqlc.narg('search') IS NULL OR original_url LIKE '%' || sqlc.narg('search') || '%');

    -- name: DeleteURL :exec
    DELETE FROM urls WHERE short_code = ?;
    ```

    Note: Use `sqlc.narg()` for nullable parameters and `sqlc.arg()` for required parameters to get proper Go types. Use `CASE WHEN` for safe ORDER BY direction (prevents SQL injection). Only `created_at` sorting is supported (not `clicks` — clicks come from Analytics Service). The LIKE is case-insensitive by default in SQLite for ASCII characters — use the query as-is; the COLLATE NOCASE index handles optimization.

    **3. Update `db/schema.sql`** to add the indexes (for sqlc schema reference):
    Add the same two CREATE INDEX statements after the CREATE TABLE.

    **4. Regenerate sqlc code:**
    ```bash
    sqlc generate
    ```

    **5. Extend `URLRepository` interface** in `internal/urlservice/usecase/url_repository.go`:
    Add three new methods:
    - `FindAll(ctx context.Context, params FindAllParams) ([]domain.URL, error)` — returns paginated, filtered URLs
    - `Count(ctx context.Context, params CountParams) (int64, error)` — returns total count matching filters
    - `Delete(ctx context.Context, shortCode string) error` — hard delete by short code

    Define filter param structs in the same file:
    ```go
    type FindAllParams struct {
        CreatedAfter  time.Time // zero value means no filter
        CreatedBefore time.Time // zero value means no filter
        Search        string    // empty means no filter
        SortOrder     string    // "asc" or "desc"
        Limit         int
        Offset        int
    }

    type CountParams struct {
        CreatedAfter  time.Time
        CreatedBefore time.Time
        Search        string
    }
    ```

    **6. Implement new methods** in `internal/urlservice/repository/sqlite/url_repository.go`:

    For `FindAll`: Convert Go params to sqlc nullable types:
    - `time.Time` zero value → `sql.NullString{Valid: false}` (use string representation for SQLite datetime compatibility)
    - Non-zero `time.Time` → `sql.NullString{String: t.Format("2006-01-02T15:04:05Z"), Valid: true}`
    - Empty string search → `sql.NullString{Valid: false}`
    - Non-empty search → `sql.NullString{String: search, Valid: true}`

    Convert sqlc results to `[]domain.URL` (same pattern as existing `FindByShortCode`).

    For `Count`: Same nullable parameter conversion, return `int64`.

    For `Delete`: Call `r.queries.DeleteURL(ctx, shortCode)`. Return error directly (no special handling for 0 rows — idempotent per research recommendation).

    Ensure compile-time interface check `var _ usecase.URLRepository = (*URLRepository)(nil)` still passes.
  </action>
  <verify>
    1. `sqlc generate` completes without errors
    2. `go build ./internal/urlservice/...` compiles successfully
    3. `go vet ./internal/urlservice/...` passes
    4. Migration files exist at expected paths
    5. sqlc generated code includes ListURLs, CountURLs, DeleteURL functions
  </verify>
  <done>
    URLRepository interface extended with FindAll, Count, Delete. SQLite repository implements all three using sqlc-generated queries. Migration adds created_at and original_url indexes. All code compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Service layer, HTTP handlers, and router for list/detail/delete with click count enrichment</name>
  <files>
    internal/urlservice/usecase/url_service.go
    internal/urlservice/delivery/http/handler.go
    internal/urlservice/delivery/http/response.go
    internal/urlservice/delivery/http/router.go
    internal/shared/events/link_deleted_event.go
    cmd/url-service/main.go
  </files>
  <action>
    **1. Create `internal/shared/events/link_deleted_event.go`:**
    ```go
    package events

    import "time"

    type LinkDeletedEvent struct {
        ShortCode string    `json:"short_code"`
        DeletedAt time.Time `json:"deleted_at"`
    }
    ```

    **2. Extend URLService** in `internal/urlservice/usecase/url_service.go`:

    Add Dapr client and logger dependencies to URLService struct:
    ```go
    type URLService struct {
        repo       URLRepository
        daprClient dapr.Client  // may be nil
        logger     *zap.Logger
        baseURL    string
    }
    ```

    Update `NewURLService` to accept `daprClient dapr.Client`, `logger *zap.Logger`, and `baseURL string`. Update call site in `cmd/url-service/main.go` accordingly.

    Add response types:
    ```go
    type LinkWithClicks struct {
        ShortCode   string    `json:"short_code"`
        ShortURL    string    `json:"short_url"`
        OriginalURL string    `json:"original_url"`
        CreatedAt   time.Time `json:"created_at"`
        TotalClicks int64     `json:"total_clicks"`
    }

    type LinkListResult struct {
        Links      []LinkWithClicks `json:"links"`
        Total      int64            `json:"total"`
        Page       int              `json:"page"`
        PerPage    int              `json:"per_page"`
        TotalPages int              `json:"total_pages"`
    }

    type ListLinksParams struct {
        Page          int
        PerPage       int
        Sort          string    // "created_at" only for now
        Order         string    // "asc" or "desc"
        CreatedAfter  time.Time
        CreatedBefore time.Time
        Search        string
    }
    ```

    Add `ListLinks` method:
    - Calculate offset: `(params.Page - 1) * params.PerPage`
    - Validate sort: only "created_at" allowed (default "created_at")
    - Validate order: only "asc" or "desc" (default "desc")
    - Call `repo.FindAll` with filters, limit, offset
    - Call `repo.Count` with same filters
    - Extract short codes from results
    - Call `getClickCounts(ctx, shortCodes)` for click count enrichment
    - Build `LinkWithClicks` slice with `baseURL + "/" + shortCode` for short_url
    - Calculate `totalPages = ceil(total / perPage)`
    - Return `LinkListResult`

    Add `GetLinkDetail` method:
    - Call `repo.FindByShortCode`
    - If not found, return `domain.ErrURLNotFound`
    - Fetch click count via `getClickCounts(ctx, []string{shortCode})`
    - Return single `LinkWithClicks`

    Add `DeleteLink` method:
    - Call `repo.Delete(ctx, shortCode)` — idempotent, always succeeds
    - Fire-and-forget: publish `LinkDeletedEvent` to topic "link-deleted" via Dapr pub/sub
    - If Dapr client is nil or publish fails, log warning but don't return error (deletion already succeeded)
    - Return nil

    Add private `getClickCounts` method:
    - If daprClient is nil → return empty map (all zeros)
    - Create `context.WithTimeout(ctx, 5*time.Second)`
    - For each short code, call `daprClient.InvokeMethod(ctx, "analytics-service", "analytics/"+code, "get")`
    - Parse JSON response to extract `total_clicks` field
    - On any error (timeout, parse, unavailable) → log warning, use 0 for that code
    - Return `map[string]int64`

    **3. Add HTTP handlers** in `internal/urlservice/delivery/http/handler.go`:

    `ListLinks(w, r)` — handles GET /api/v1/links:
    - Parse query params: page (default 1), per_page (default 20, max 100), sort (default "created_at"), order (default "desc"), created_after, created_before (parse "2006-01-02" format), search
    - Validate: page >= 1, 1 <= per_page <= 100, sort whitelist ["created_at"], order whitelist ["asc", "desc"]
    - For created_before, add end-of-day (23:59:59) to include the entire date
    - Call `h.service.ListLinks(r.Context(), params)`
    - On error → 500 RFC 7807
    - On success → 200 with LinkListResult JSON

    `GetLinkDetail(w, r)` — handles GET /api/v1/links/{code}:
    - Extract {code} from URL
    - Call `h.service.GetLinkDetail(r.Context(), code)`
    - On ErrURLNotFound → 404 RFC 7807
    - On other error → 500 RFC 7807
    - On success → 200 with LinkWithClicks JSON

    `DeleteLink(w, r)` — handles DELETE /api/v1/links/{code}:
    - Extract {code} from URL
    - Call `h.service.DeleteLink(r.Context(), code)`
    - On error → 500 RFC 7807
    - On success → 204 No Content (no body)
    - Idempotent: always returns 204, even if link didn't exist

    **4. Add response types** in `internal/urlservice/delivery/http/response.go` if needed for type documentation.

    **5. Update router** in `internal/urlservice/delivery/http/router.go`:
    Add new route group under `/api/v1`:
    ```go
    r.Route("/api/v1", func(r chi.Router) {
        // Existing URL shortening routes
        r.Post("/urls", handler.CreateShortURL)
        r.Get("/urls/{code}", handler.GetURLDetails)

        // Link management routes
        r.Get("/links", handler.ListLinks)
        r.Get("/links/{code}", handler.GetLinkDetail)
        r.Delete("/links/{code}", handler.DeleteLink)
    })
    ```

    **6. Update `cmd/url-service/main.go`:**
    Pass `daprClient`, `logger`, and `baseURL` to `NewURLService`. The `daprClient` and `logger` are already available in main.go from Phase 2 changes.

    **Discretion choices:**
    - Analytics Service unavailability: 5-second timeout, fallback to 0 clicks, log warning (graceful degradation)
    - Response envelope: Standard JSON object with links array and pagination metadata (no wrapper)
    - Delete confirmation: Immediate delete, no confirmation header required (simpler, REST-idiomatic)
    - Index strategy: Separate indexes on created_at DESC and original_url COLLATE NOCASE (per research)
  </action>
  <verify>
    1. `go build ./cmd/url-service/` compiles successfully
    2. `go vet ./...` passes
    3. Start URL Service and verify:
       - `curl -s http://localhost:8080/api/v1/links | jq .` returns paginated list with links array, total, page, per_page, total_pages
       - `curl -s http://localhost:8080/api/v1/links?page=1&per_page=5 | jq .` returns at most 5 links
       - `curl -s http://localhost:8080/api/v1/links?search=example | jq .` filters by original URL
       - `curl -s http://localhost:8080/api/v1/links/{code} | jq .` returns single link with total_clicks
       - `curl -s -X DELETE http://localhost:8080/api/v1/links/{code} -w "%{http_code}"` returns 204
       - Deleting same code again returns 204 (idempotent)
    4. Verify link.deleted event published (check logs for publish confirmation or Dapr warning)
  </verify>
  <done>
    Three new endpoints operational: GET /api/v1/links (paginated list with click counts), GET /api/v1/links/:code (single link detail), DELETE /api/v1/links/:code (hard delete with event). Click counts enriched from Analytics Service with 5s timeout and graceful degradation. LinkDeletedEvent published on delete.
  </done>
</task>

</tasks>

<verification>
1. `go build ./cmd/url-service/ && go build ./cmd/analytics-service/` — both services compile
2. `go vet ./...` — no issues across entire codebase
3. GET /api/v1/links returns JSON with links[], total, page, per_page, total_pages fields
4. GET /api/v1/links?search=... filters results (case-insensitive)
5. GET /api/v1/links?created_after=2026-01-01&created_before=2026-02-01 filters by date range
6. GET /api/v1/links/:code returns single link with total_clicks
7. DELETE /api/v1/links/:code returns 204 and link is gone from subsequent list
8. Repeat DELETE returns 204 (idempotent)
</verification>

<success_criteria>
- All three link management endpoints return correct HTTP status codes and response shapes
- Pagination metadata (total, page, per_page, total_pages) is accurate
- Click counts appear in responses (0 when Analytics Service unavailable)
- Delete removes link from URL Service and publishes event
- No regressions in existing URL shortening or redirect functionality
</success_criteria>

<output>
After completion, create `.planning/phases/04-link-management/04-01-SUMMARY.md`
</output>
