---
milestone: v2.0
audited: 2026-02-16
status: tech_debt
scores:
  requirements: 33/40
  phases: 4/4
  integration: 23/23
  flows: 4.5/5
gaps:
  requirements:
    - "INFR-04: CI pipeline references v1.0 paths (cmd/, Dockerfile.*, test/integration/) — will fail on push"
  integration: []
  flows:
    - "Kafka publishing from url-api not working in Docker environment (local dev works)"
tech_debt:
  - phase: 08-database-migration
    items:
      - "DBMG-03: Connection pool (MaxOpenConns, MaxIdleConns, ConnMaxLifetime) not explicitly configured — using Go defaults"
      - "DBMG-06: Offset/limit pagination implemented instead of cursor pagination as specified"
  - phase: 09-messaging-migration
    items:
      - "MSNG-05: Kafka topic auto-created with defaults — no explicit retention or replication config"
      - "Phase 9 has no SUMMARY files — all work committed as single 'up' commit (e162de9)"
  - phase: 10-resilience-infrastructure
    items:
      - "INFR-04: CI pipeline (.github/workflows/ci.yml) NOT updated for v2.0 — references old paths"
      - "TEST-02: No integration tests with testcontainers-go (deferred intentionally)"
      - "TEST-03: E2E flow smoke-tested manually via curl, not automated test suite"
      - "TEST-04: Consumer coverage at 76.4% (below 80% target) — GeoIP requires real database file"
      - "Kafka publishing fails in Docker (kq.Pusher silent failure) — works in local dev"
      - "analytics-consumer healthz returns Service Unavailable instead of OK"
      - "mssola/useragent library does not detect mobile devices (iPhone/Android)"
      - "GeoIP database not included in Docker images — falls back to XX country code"
---

# v2.0 Milestone Audit: Go-Zero Adoption

**Audited:** 2026-02-16
**Milestone Goal:** Full stack rewrite from Chi/Dapr/SQLite to go-zero/zRPC/Kafka/PostgreSQL with feature parity.

## Executive Summary

**Status: TECH DEBT** — All core functionality works end-to-end. No critical blockers. 33/40 requirements fully satisfied, 7 partial. Accumulated tech debt across testing, CI, and Docker environments needs review before closing milestone.

The rewrite from Chi/Dapr/SQLite to go-zero/zRPC/Kafka/PostgreSQL is **functionally complete**. URL shortening, redirect, click analytics, link management, Kafka event pipeline, zRPC service communication, Prometheus metrics, and Docker Compose orchestration all work. The gaps are in testing depth, CI pipeline updates, and configuration fine-tuning.

## Requirements Coverage

### Framework Adoption (9/9 satisfied)

| Req | Description | Status | Phase |
|-----|-------------|--------|-------|
| FWRK-01 | URL Service `.api` spec with goctl code gen | ✅ Satisfied | 7 |
| FWRK-02 | Analytics Service `.proto` spec with zRPC gen | ✅ Satisfied | 7 |
| FWRK-03 | Handler/Logic/Model separation enforced | ✅ Satisfied | 7-8 |
| FWRK-04 | ServiceContext DI for DB, RPC, Kafka | ✅ Satisfied | 8-9 |
| FWRK-05 | Request validation via `.api` tag rules | ✅ Satisfied | 7 |
| FWRK-06 | RFC 7807 Problem Details via httpx.SetErrorHandler | ✅ Satisfied | 7-8 |
| FWRK-07 | Config loaded from YAML via Config struct | ✅ Satisfied | 7 |
| FWRK-08 | Service groups organize routes by domain | ✅ Satisfied | 7 |
| FWRK-09 | go-zero logx replaces Zap logger | ✅ Satisfied | 7 |

### Database Migration (5/7 satisfied)

| Req | Description | Status | Phase | Notes |
|-----|-------------|--------|-------|-------|
| DBMG-01 | PostgreSQL schema (urls, clicks) | ✅ Satisfied | 8 | |
| DBMG-02 | goctl model generates type-safe CRUD | ✅ Satisfied | 8 | |
| DBMG-03 | Connection pool configured | ⚠ Partial | 8 | Using Go/go-zero defaults, not explicitly set |
| DBMG-04 | URL Service reads/writes PostgreSQL | ✅ Satisfied | 8 | |
| DBMG-05 | Analytics Service reads/writes clicks | ✅ Satisfied | 8-9 | |
| DBMG-06 | Cursor pagination works | ⚠ Partial | 8 | Offset/limit implemented instead of cursor |
| DBMG-07 | Search and filtering work | ✅ Satisfied | 8 | ILIKE search, sort, order |

### Messaging Migration (5/6 satisfied)

| Req | Description | Status | Phase | Notes |
|-----|-------------|--------|-------|-------|
| MSNG-01 | Kafka publishing via kq.Pusher | ✅ Satisfied | 9 | Works locally, fails in Docker |
| MSNG-02 | Consumer processes via kq.Queue | ✅ Satisfied | 9 | |
| MSNG-03 | Click enrichment (GeoIP, UA, referer) | ✅ Satisfied | 9 | |
| MSNG-04 | Fire-and-forget pattern preserved | ✅ Satisfied | 9 | threading.GoSafe |
| MSNG-05 | Kafka topic retention and replication | ⚠ Partial | 9 | Auto-created, no explicit config |
| MSNG-06 | Idempotent duplicate handling | ✅ Satisfied | 9 | |

### Service Communication (4/4 satisfied)

| Req | Description | Status | Phase |
|-----|-------------|--------|-------|
| SRVC-01 | GetClickCount via zRPC | ✅ Satisfied | 7-8 |
| SRVC-02 | URL Service calls Analytics zRPC | ✅ Satisfied | 9 |
| SRVC-03 | Protobuf schema defines types | ✅ Satisfied | 7 |
| SRVC-04 | zRPC client with circuit breaker | ✅ Satisfied | 9-10 |

### Resilience & Observability (6/6 satisfied)

| Req | Description | Status | Phase |
|-----|-------------|--------|-------|
| RESL-01 | Adaptive load shedding | ✅ Satisfied | 10 | Built-in |
| RESL-02 | Circuit breaker on downstream calls | ✅ Satisfied | 10 | Built-in Google SRE breaker |
| RESL-03 | Request timeout per-service | ✅ Satisfied | 10 | REST: 30s, zRPC: 2s |
| RESL-04 | MaxConns limiting | ✅ Satisfied | 10 | MaxConns=10000 |
| RESL-05 | Prometheus metrics on /metrics | ✅ Satisfied | 10 | DevServer on 6470/6471/6472 |
| RESL-06 | OpenTelemetry tracing enabled | ✅ Satisfied | 10 | Built-in middleware |

### Infrastructure (3/4 satisfied)

| Req | Description | Status | Phase | Notes |
|-----|-------------|--------|-------|-------|
| INFR-01 | Docker Compose runs all services | ✅ Satisfied | 10 | KRaft mode (no Zookeeper) |
| INFR-02 | Services start and connect correctly | ✅ Satisfied | 10 | Health-based ordering |
| INFR-03 | Makefile for build, run, code gen | ✅ Satisfied | 7-10 | |
| INFR-04 | CI pipeline updated for go-zero | ❌ Gap | — | Still references v1.0 paths |

### Testing (1/4 satisfied)

| Req | Description | Status | Phase | Notes |
|-----|-------------|--------|-------|-------|
| TEST-01 | Unit tests with mocked dependencies | ✅ Satisfied | 10 | 41 tests, hand-written mocks |
| TEST-02 | Integration tests with testcontainers | ❌ Gap | — | Deferred intentionally |
| TEST-03 | E2E flow tested | ⚠ Partial | 10 | Smoke-tested via curl, not automated |
| TEST-04 | 80%+ test coverage | ⚠ Partial | 10 | Logic: 84-100%, Consumer: 76.4% |

## Phase Verification Status

| Phase | Plans | Summaries | Verification | Status |
|-------|-------|-----------|--------------|--------|
| 7. Framework Foundation | 3/3 ✅ | 3/3 ✅ | No file (verifier disabled) | Complete |
| 8. Database Migration | 3/3 ✅ | 3/3 ✅ | No file (verifier disabled) | Complete |
| 9. Messaging Migration | 3/3 ✅ | 0/3 ⚠ | No file (verifier disabled) | Complete (no summaries) |
| 10. Resilience & Infrastructure | 3/3 ✅ | 3/3 ✅ | No file (verifier disabled) | Complete |

**Note:** Phase 9 was executed as a single commit (`e162de9 "up"`) without individual plan summaries. All code is present and functional.

## Cross-Phase Integration

**Integration checker results:** 23 integration points verified, 0 orphaned exports, 0 missing connections.

| Integration Point | Status |
|-------------------|--------|
| url-api → analyticsclient (zRPC) | ✅ Connected with graceful degradation |
| url-api → Kafka (kq.Pusher) | ✅ Connected (local), ⚠ fails in Docker |
| analytics-consumer → Kafka (kq.Queue) | ✅ Connected |
| analytics-consumer → ClicksModel (shared) | ✅ Connected |
| common/events.ClickEvent (cross-service) | ✅ Used by url-api and analytics-consumer |
| pkg/problemdetails (error handling) | ✅ Used by all url-api logic |
| Config consistency (ports, hosts) | ✅ Local and Docker configs aligned |
| Import paths (module-qualified) | ✅ All cross-service imports resolve |

## E2E Flow Verification

| Flow | Path | Status |
|------|------|--------|
| 1. URL Shortening | POST /api/v1/urls → DB insert | ✅ Complete |
| 2. Redirect + Analytics | GET /:code → redirect → Kafka → enrich → DB | ⚠ Partial (Docker Kafka issue) |
| 3. Link Detail + zRPC | GET /links/:code → DB + GetClickCount RPC | ✅ Complete |
| 4. Link Listing | GET /links → paginated query | ✅ Complete |
| 5. Link Deletion | DELETE /links/:code → DB delete | ✅ Complete |

## Tech Debt by Phase

### Phase 8: Database Migration
- **DBMG-03:** Connection pool parameters (MaxOpenConns, MaxIdleConns, ConnMaxLifetime) not explicitly configured — using Go/go-zero defaults
- **DBMG-06:** Offset/limit pagination implemented instead of cursor pagination — maintains v1.0 API contract but doesn't match requirement spec

### Phase 9: Messaging Migration
- **MSNG-05:** Kafka topic `click-events` auto-created with broker defaults — no explicit retention or replication configuration
- **Documentation:** No SUMMARY files for Phase 9 plans — all work committed as single commit without per-plan tracking

### Phase 10: Resilience & Infrastructure
- **INFR-04:** CI pipeline (`.github/workflows/ci.yml`) still references v1.0 paths (`cmd/`, `Dockerfile.*`, `test/integration/`) — will fail on push
- **TEST-02:** No integration tests with testcontainers-go — deferred intentionally
- **TEST-03:** E2E flow verified via manual curl smoke tests, not automated test suite
- **TEST-04:** Consumer coverage at 76.4% (below 80% target) — `resolveCountry` requires real GeoIP `.mmdb` file
- **Docker Kafka:** `kq.Pusher.Push()` fails silently in Docker environment — url-api can reach Kafka network but messages don't publish
- **Consumer health:** `analytics-consumer` healthz endpoint returns "Service Unavailable" — DevServer runs but health check doesn't reflect consumer readiness
- **UA parsing:** `mssola/useragent` library does not detect iPhone/Android user agents — classifies as Desktop
- **GeoIP in Docker:** GeoLite2-Country.mmdb not included in Docker images — all clicks fall back to "XX" country code

### Total: 12 items across 3 phases

## Milestone Success Criteria Assessment

From ROADMAP.md Phase 10 success criteria:

| # | Criterion | Status |
|---|-----------|--------|
| 1 | Prometheus metrics on /metrics with request duration and status code data | ✅ Met |
| 2 | Circuit breaker protects PostgreSQL and Kafka calls | ✅ Met (built-in) |
| 3 | Docker Compose starts all services successfully | ✅ Met |
| 4 | E2E flow: shorten → redirect → click event → analytics enriched → counts queryable | ⚠ Mostly met (works locally, Kafka issue in Docker) |
| 5 | Test coverage 80%+ with unit and integration tests passing in CI | ⚠ Partially met (logic 84-100%, consumer 76.4%, CI not updated) |

## Build Verification

- `go build ./...` — **PASSES** (all packages compile)
- `go test ./...` — **PASSES** (41/41 tests pass)
- No lint errors in compiled code

## Recommendations

### Must fix before closing milestone
1. **Update CI pipeline** for v2.0 paths (INFR-04) — currently broken
2. **Investigate Docker Kafka publishing** — silent failure in kq.Pusher

### Should address (tech debt)
3. Add explicit PostgreSQL connection pool configuration (DBMG-03)
4. Add Kafka topic creation with explicit retention settings (MSNG-05)
5. Write Phase 9 SUMMARY files retroactively or accept missing documentation

### Can defer to v2.1
6. Integration tests with testcontainers (TEST-02)
7. Automated E2E test suite (TEST-03)
8. Cursor pagination migration (DBMG-06)
9. Improve consumer coverage past 80% (TEST-04)
10. Fix analytics-consumer health check
11. Bundle GeoIP database in Docker images

---
*Audit completed: 2026-02-16*
*Integration checker: 23/23 points verified, 5 E2E flows traced*
