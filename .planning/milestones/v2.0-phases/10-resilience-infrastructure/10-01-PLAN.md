---
phase: 10-resilience-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/url-api/etc/url.yaml
  - services/analytics-rpc/etc/analytics.yaml
  - services/analytics-consumer/etc/consumer.yaml
  - services/analytics-consumer/internal/config/config.go
  - services/analytics-consumer/consumer.go
autonomous: true

must_haves:
  truths:
    - "url-api exposes Prometheus metrics on localhost:6470/metrics"
    - "analytics-rpc exposes Prometheus metrics on localhost:6471/metrics"
    - "http_server_requests_duration_ms and http_server_requests_code_total are present in url-api /metrics output"
    - "Circuit breaker is active on zRPC client calls (default, no code changes needed)"
    - "MaxConns and Timeout are configured on url-api"
    - "OpenTelemetry tracing middleware is enabled (default)"
  artifacts:
    - path: "services/url-api/etc/url.yaml"
      provides: "DevServer config for Prometheus metrics"
      contains: "DevServer"
    - path: "services/analytics-rpc/etc/analytics.yaml"
      provides: "DevServer config for Prometheus metrics"
      contains: "DevServer"
    - path: "services/analytics-consumer/etc/consumer.yaml"
      provides: "DevServer config for Prometheus metrics"
      contains: "DevServer"
  key_links:
    - from: "services/url-api/etc/url.yaml"
      to: "localhost:6470/metrics"
      via: "DevServer port"
      pattern: "Port: 6470"
    - from: "services/analytics-rpc/etc/analytics.yaml"
      to: "localhost:6471/metrics"
      via: "DevServer port"
      pattern: "Port: 6471"
---

<objective>
Enable go-zero production features: Prometheus metrics via DevServer, verify built-in circuit breakers and load shedding are active, and configure request timeouts and connection limits.

Purpose: Satisfy RESL-01 through RESL-06 requirements. go-zero provides these features out-of-the-box — this plan enables and configures them via YAML, no custom middleware code needed.

Output: All three services expose Prometheus metrics on unique DevServer ports, with circuit breakers, load shedding, timeouts, and tracing active.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-resilience-infrastructure/10-RESEARCH.md
@services/url-api/etc/url.yaml
@services/analytics-rpc/etc/analytics.yaml
@services/analytics-consumer/etc/consumer.yaml
@services/analytics-consumer/internal/config/config.go
@services/analytics-consumer/consumer.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable DevServer Prometheus metrics on all three services</name>
  <files>
    services/url-api/etc/url.yaml
    services/analytics-rpc/etc/analytics.yaml
    services/analytics-consumer/etc/consumer.yaml
    services/analytics-consumer/internal/config/config.go
    services/analytics-consumer/consumer.go
  </files>
  <action>
    1. **Update `services/url-api/etc/url.yaml`**:
       Add DevServer config block to enable Prometheus metrics. Also ensure Timeout and MaxConns are set:
       ```yaml
       Name: url-api
       Host: 0.0.0.0
       Port: 8080
       Timeout: 30000
       MaxConns: 10000

       DevServer:
         Enabled: true
         Port: 6470
         MetricsPath: /metrics
         HealthPath: /healthz

       Log:
         ServiceName: url-api
         Mode: console
         Level: info

       BaseUrl: http://localhost:8080
       DataSource: postgres://postgres:postgres@localhost:5433/shortener?sslmode=disable

       KqPusherConf:
         Brokers:
           - localhost:9092
         Topic: click-events

       AnalyticsRpc:
         Target: dns:///localhost:8081
         NonBlock: true
         Timeout: 2000
       ```

       **Key changes:**
       - `DevServer.Enabled: true` starts the DevServer on port 6470
       - `DevServer.Port: 6470` — unique port for this service
       - `DevServer.HealthPath: /healthz` — health check endpoint for Docker
       - `Timeout: 30000` already present (30s request timeout, RESL-03)
       - `MaxConns: 10000` already present (concurrent connection limit, RESL-04)
       - Circuit breaker is enabled by default on AnalyticsRpc zRPC client (RESL-02)
       - Prometheus middleware enabled by default on REST server (RESL-05)
       - Tracing middleware enabled by default (RESL-06)

    2. **Update `services/analytics-rpc/etc/analytics.yaml`**:
       Add DevServer config and verify timeout settings:
       ```yaml
       Name: analytics-rpc
       ListenOn: 0.0.0.0:8081

       DevServer:
         Enabled: true
         Port: 6471
         MetricsPath: /metrics
         HealthPath: /healthz

       Log:
         ServiceName: analytics-rpc
         Mode: console
         Level: info

       DataSource: postgres://postgres:postgres@localhost:5433/shortener?sslmode=disable
       ```

       **Key changes:**
       - `DevServer.Port: 6471` — different from url-api to avoid port conflict
       - zRPC server has built-in ServerMiddlewaresConf with Prometheus, Breaker, Trace all defaulting to true

    3. **Update `services/analytics-consumer/etc/consumer.yaml`**:
       Add DevServer config. The consumer is not an HTTP/RPC server but go-zero's service.ServiceConf supports DevServer:
       ```yaml
       Name: analytics-consumer

       DevServer:
         Enabled: true
         Port: 6472
         MetricsPath: /metrics
         HealthPath: /healthz

       Log:
         ServiceName: analytics-consumer
         Mode: console
         Level: info

       DataSource: postgres://postgres:postgres@localhost:5433/shortener?sslmode=disable

       KqConsumerConf:
         Name: clickEventConsumer
         Brokers:
           - localhost:9092
         Group: analytics-consumer
         Topic: click-events
         Offset: first
         Consumers: 4
         Processors: 4

       GeoIPPath: data/GeoLite2-Country.mmdb
       ```

       **Key change:** `DevServer.Port: 6472` — unique port for consumer metrics.

    4. **Update `services/analytics-consumer/internal/config/config.go`**:
       Add `service.ServiceConf` embedding so DevServer config is parsed:
       ```go
       package config

       import (
         "github.com/zeromicro/go-queue/kq"
         "github.com/zeromicro/go-zero/core/service"
       )

       type Config struct {
         service.ServiceConf
         DataSource     string
         KqConsumerConf kq.KqConf
         GeoIPPath      string `json:",optional"`
       }
       ```

       **Key change:** Embed `service.ServiceConf` (which includes `DevServer` field) so the consumer can parse DevServer config from YAML.

    5. **Update `services/analytics-consumer/consumer.go`**:
       Setup DevServer for the consumer service if config is present. The consumer main entry needs to start the DevServer alongside the Kafka consumer so that Prometheus can scrape metrics:
       ```go
       package main

       import (
         "flag"
         "fmt"

         "go-shortener/services/analytics-consumer/internal/config"
         "go-shortener/services/analytics-consumer/internal/mqs"
         "go-shortener/services/analytics-consumer/internal/svc"

         "github.com/zeromicro/go-queue/kq"
         "github.com/zeromicro/go-zero/core/conf"
         "github.com/zeromicro/go-zero/core/service"
       )

       var configFile = flag.String("f", "etc/consumer.yaml", "config file")

       func main() {
         flag.Parse()

         var c config.Config
         conf.MustLoad(*configFile, &c)
         svcCtx := svc.NewServiceContext(c)

         group := service.NewServiceGroup()
         defer group.Stop()

         group.Add(kq.MustNewQueue(c.KqConsumerConf, mqs.NewClickEventConsumer(context.Background(), svcCtx)))

         fmt.Printf("Starting analytics consumer, listening on topic %s...\n", c.KqConsumerConf.Topic)
         group.Start()
       }
       ```

       **Note:** The `service.ServiceConf` embedding handles DevServer lifecycle automatically when `conf.MustLoad` is called. go-zero starts the DevServer as part of the service group internals. If this does not auto-start the DevServer for non-HTTP services, add explicit `devserver.NewServer(c.DevServer).Start()` call — verify during implementation.
  </action>
  <verify>
    - `go build ./...` compiles without errors
    - Start url-api: `make run-url` then `curl http://localhost:6470/metrics` returns Prometheus metrics
    - Verify `http_server_requests_duration_ms` and `http_server_requests_code_total` metrics appear after making a few requests
    - Start analytics-rpc: `make run-analytics` then `curl http://localhost:6471/metrics` returns Prometheus metrics
    - Start analytics-consumer: `make run-consumer` then `curl http://localhost:6472/metrics` returns metrics (at minimum Go runtime metrics)
    - Health check: `curl http://localhost:6470/healthz` returns OK
  </verify>
  <done>All three services expose Prometheus metrics on unique DevServer ports with health check endpoints</done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors
2. `curl http://localhost:6470/metrics` returns Prometheus metrics for url-api
3. `curl http://localhost:6471/metrics` returns Prometheus metrics for analytics-rpc
4. `curl http://localhost:6472/metrics` returns metrics for analytics-consumer
5. `http_server_requests_duration_ms` histogram present after making HTTP requests to url-api
6. `http_server_requests_code_total` counter present with path and status code labels
7. Health endpoints respond on `/healthz` for all services
</verification>

<success_criteria>
- url-api DevServer on port 6470 with /metrics exposing request duration and status code metrics
- analytics-rpc DevServer on port 6471 with /metrics
- analytics-consumer DevServer on port 6472 with /metrics
- Timeout (30s) and MaxConns (10000) configured on url-api
- Circuit breaker active on zRPC client (verified by default ServerMiddlewaresConf)
- OpenTelemetry tracing middleware active (default Trace=true)
- All services compile and start correctly
</success_criteria>

<output>
After completion, create `.planning/phases/10-resilience-infrastructure/10-01-SUMMARY.md`
</output>
