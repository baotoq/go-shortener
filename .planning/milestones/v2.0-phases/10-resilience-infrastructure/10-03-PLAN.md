---
phase: 10-resilience-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - go.mod
  - go.sum
  - services/url-api/internal/logic/shorten/shortenlogic_test.go
  - services/url-api/internal/logic/redirect/redirectlogic_test.go
  - services/url-api/internal/logic/links/getlinkdetaillogic_test.go
  - services/url-api/internal/logic/links/listlinkslogic_test.go
  - services/url-api/internal/logic/links/deletelinklogic_test.go
  - services/analytics-rpc/internal/logic/getclickcountlogic_test.go
  - services/analytics-consumer/internal/mqs/clickeventconsumer_test.go
  - services/url-api/model/mock_urlsmodel.go
  - services/analytics-rpc/model/mock_clicksmodel.go
  - Makefile
autonomous: true

must_haves:
  truths:
    - "Unit tests exist for all logic files (shorten, redirect, getlinkdetail, listlinks, deletelink, getclickcount, clickeventconsumer)"
    - "Tests use mock interfaces for UrlsModel, ClicksModel, and Analytics RPC client"
    - "All tests pass with go test ./..."
    - "Test coverage is 80%+ for logic packages"
    - "Tests cover both success and error paths (not found, DB errors, RPC failures)"
  artifacts:
    - path: "services/url-api/internal/logic/shorten/shortenlogic_test.go"
      provides: "Unit tests for URL shortening logic"
      contains: "TestShortenLogic"
    - path: "services/url-api/internal/logic/redirect/redirectlogic_test.go"
      provides: "Unit tests for redirect logic"
      contains: "TestRedirectLogic"
    - path: "services/analytics-rpc/internal/logic/getclickcountlogic_test.go"
      provides: "Unit tests for click count logic"
      contains: "TestGetClickCountLogic"
    - path: "services/analytics-consumer/internal/mqs/clickeventconsumer_test.go"
      provides: "Unit tests for click event consumer"
      contains: "TestClickEventConsumer"
  key_links:
    - from: "services/url-api/internal/logic/shorten/shortenlogic_test.go"
      to: "services/url-api/model/mock_urlsmodel.go"
      via: "MockUrlsModel dependency injection"
      pattern: "MockUrlsModel"
    - from: "services/url-api/internal/logic/links/getlinkdetaillogic_test.go"
      to: "services/analytics-rpc/analyticsclient/analytics.go"
      via: "Mock Analytics RPC client"
      pattern: "MockAnalytics"
---

<objective>
Write comprehensive unit tests for all logic layers and the Kafka consumer. Use mock interfaces for database models and RPC clients. Target 80%+ coverage across logic packages.

Purpose: Satisfy TEST-01 and TEST-04 requirements. Unit tests with mocked dependencies validate business logic independently of infrastructure.

Output: Full test suite covering success paths, error paths, and edge cases for all seven logic/consumer functions. All tests pass with `go test ./...`.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-resilience-infrastructure/10-RESEARCH.md
@services/url-api/internal/logic/shorten/shortenlogic.go
@services/url-api/internal/logic/redirect/redirectlogic.go
@services/url-api/internal/logic/links/getlinkdetaillogic.go
@services/url-api/internal/logic/links/listlinkslogic.go
@services/url-api/internal/logic/links/deletelinklogic.go
@services/analytics-rpc/internal/logic/getclickcountlogic.go
@services/analytics-consumer/internal/mqs/clickeventconsumer.go
@services/url-api/model/urlsmodel.go
@services/analytics-rpc/model/clicksmodel.go
@services/url-api/internal/svc/servicecontext.go
@services/analytics-rpc/internal/svc/servicecontext.go
@services/analytics-consumer/internal/svc/servicecontext.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mock implementations for model interfaces</name>
  <files>
    go.mod
    go.sum
    services/url-api/model/mock_urlsmodel.go
    services/analytics-rpc/model/mock_clicksmodel.go
  </files>
  <action>
    1. **Install testify** (if not already):
       ```bash
       go get github.com/stretchr/testify@latest
       ```

    2. **Create `services/url-api/model/mock_urlsmodel.go`**:
       Hand-written mock implementing the `UrlsModel` interface. Using hand-written mocks (not mockgen) to keep it simple and avoid adding code generation tooling:
       ```go
       package model

       import (
         "context"
         "github.com/zeromicro/go-zero/core/stores/sqlx"
       )

       // MockUrlsModel is a test mock for UrlsModel interface.
       type MockUrlsModel struct {
         FindOneFunc              func(ctx context.Context, id string) (*Urls, error)
         FindOneByShortCodeFunc   func(ctx context.Context, shortCode string) (*Urls, error)
         InsertFunc               func(ctx context.Context, data *Urls) (sql.Result, error)
         UpdateFunc               func(ctx context.Context, data *Urls) error
         DeleteFunc               func(ctx context.Context, id string) error
         ListWithPaginationFunc   func(ctx context.Context, page, pageSize int, search, sort, order string) ([]*Urls, int64, error)
         IncrementClickCountFunc  func(ctx context.Context, shortCode string) error
       }
       ```

       Implement all methods of the `UrlsModel` interface delegating to the function fields. Methods not set (nil function) should panic with a clear message so tests fail fast if unexpected methods are called.

       **Important:** Check the `urlsModel` (lowercase) interface in `urlsmodel_gen.go` to get the exact method signatures for `FindOne`, `FindOneByShortCode`, `Insert`, `Update`, `Delete`. The mock must implement ALL methods from both `urlsModel` and the custom additions.

    3. **Create `services/analytics-rpc/model/mock_clicksmodel.go`**:
       Similar hand-written mock for `ClicksModel`:
       ```go
       package model

       type MockClicksModel struct {
         InsertFunc            func(ctx context.Context, data *Clicks) (sql.Result, error)
         FindOneFunc           func(ctx context.Context, id string) (*Clicks, error)
         UpdateFunc            func(ctx context.Context, data *Clicks) error
         DeleteFunc            func(ctx context.Context, id string) error
         CountByShortCodeFunc  func(ctx context.Context, shortCode string) (int64, error)
       }
       ```

       Check `clicksmodel_gen.go` for exact method signatures.

    4. **Run `go mod tidy`**.
  </action>
  <verify>
    - `go build ./...` compiles without errors
    - Mock implementations satisfy their respective interfaces (compile-time check via `var _ UrlsModel = (*MockUrlsModel)(nil)`)
  </verify>
  <done>Hand-written mock implementations for UrlsModel and ClicksModel interfaces</done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for URL API logic layer</name>
  <files>
    services/url-api/internal/logic/shorten/shortenlogic_test.go
    services/url-api/internal/logic/redirect/redirectlogic_test.go
    services/url-api/internal/logic/links/getlinkdetaillogic_test.go
    services/url-api/internal/logic/links/listlinkslogic_test.go
    services/url-api/internal/logic/links/deletelinklogic_test.go
  </files>
  <action>
    1. **Create `services/url-api/internal/logic/shorten/shortenlogic_test.go`**:
       Test cases:
       - **TestShortenLogic_Success**: Valid URL → returns short code, short URL, original URL
       - **TestShortenLogic_InsertError**: DB insert returns error → returns 500 ProblemDetail
       - **TestShortenLogic_CollisionRetry**: First insert returns unique violation, second succeeds → returns short code

       ```go
       package shorten

       import (
         "context"
         "testing"

         "go-shortener/services/url-api/internal/config"
         "go-shortener/services/url-api/internal/svc"
         "go-shortener/services/url-api/internal/types"
         "go-shortener/services/url-api/model"

         "github.com/stretchr/testify/assert"
         "github.com/stretchr/testify/require"
       )
       ```

       Mock setup pattern:
       ```go
       mockModel := &model.MockUrlsModel{
         InsertFunc: func(ctx context.Context, data *model.Urls) (sql.Result, error) {
           return nil, nil // Success
         },
       }
       svcCtx := &svc.ServiceContext{
         Config:   config.Config{BaseUrl: "http://localhost:8080"},
         UrlModel: mockModel,
       }
       logic := NewShortenLogic(context.Background(), svcCtx)
       resp, err := logic.Shorten(&types.ShortenRequest{OriginalUrl: "https://example.com"})
       ```

    2. **Create `services/url-api/internal/logic/redirect/redirectlogic_test.go`**:
       Test cases:
       - **TestRedirectLogic_Success**: Short code exists → returns original URL
       - **TestRedirectLogic_NotFound**: Short code not found → returns 404 ProblemDetail
       - **TestRedirectLogic_DBError**: DB returns unexpected error → returns 500 ProblemDetail

       **Note:** RedirectLogic.Redirect takes `*http.Request` parameter. Create a mock `http.Request` with `httptest.NewRequest` for testing. The Kafka push happens in `threading.GoSafe` (async) — the test should NOT verify Kafka publishing (that's fire-and-forget). Set `KqPusher` to nil or a no-op pusher in the test ServiceContext.

    3. **Create `services/url-api/internal/logic/links/getlinkdetaillogic_test.go`**:
       Test cases:
       - **TestGetLinkDetailLogic_Success**: URL found + RPC returns click count → returns full detail
       - **TestGetLinkDetailLogic_NotFound**: URL not found → returns 404
       - **TestGetLinkDetailLogic_RPCFailure**: URL found but RPC fails → returns detail with 0 clicks (graceful degradation)

       **Note:** Mock the `analyticsclient.Analytics` interface. This may need a mock implementation or use the generated client interface.

    4. **Create `services/url-api/internal/logic/links/listlinkslogic_test.go`**:
       Test cases:
       - **TestListLinksLogic_Success**: Returns paginated list with total count
       - **TestListLinksLogic_Empty**: No results → returns empty list with 0 count
       - **TestListLinksLogic_DBError**: DB error → returns 500

    5. **Create `services/url-api/internal/logic/links/deletelinklogic_test.go`**:
       Test cases:
       - **TestDeleteLinkLogic_Success**: Short code found → deleted successfully
       - **TestDeleteLinkLogic_NotFound**: Short code not found → returns 404
       - **TestDeleteLinkLogic_DeleteError**: FindOne succeeds but Delete fails → returns 500
  </action>
  <verify>
    - `go test ./services/url-api/internal/logic/...` passes all tests
    - `go test -cover ./services/url-api/internal/logic/...` shows 80%+ coverage per package
  </verify>
  <done>Unit tests for all 5 URL API logic functions with success and error path coverage</done>
</task>

<task type="auto">
  <name>Task 3: Write unit tests for Analytics RPC and Consumer</name>
  <files>
    services/analytics-rpc/internal/logic/getclickcountlogic_test.go
    services/analytics-consumer/internal/mqs/clickeventconsumer_test.go
  </files>
  <action>
    1. **Create `services/analytics-rpc/internal/logic/getclickcountlogic_test.go`**:
       Test cases:
       - **TestGetClickCountLogic_Success**: CountByShortCode returns count → returns correct response
       - **TestGetClickCountLogic_Zero**: CountByShortCode returns 0 → returns 0 (not an error)
       - **TestGetClickCountLogic_DBError**: CountByShortCode returns error → propagates error

       ```go
       package logic

       import (
         "context"
         "testing"

         "go-shortener/services/analytics-rpc/analytics"
         "go-shortener/services/analytics-rpc/internal/config"
         "go-shortener/services/analytics-rpc/internal/svc"
         "go-shortener/services/analytics-rpc/model"

         "github.com/stretchr/testify/assert"
       )
       ```

    2. **Create `services/analytics-consumer/internal/mqs/clickeventconsumer_test.go`**:
       Test cases:
       - **TestClickEventConsumer_Success**: Valid JSON event → inserts enriched click into DB
       - **TestClickEventConsumer_InvalidJSON**: Malformed JSON → returns nil (skip, don't retry)
       - **TestClickEventConsumer_DuplicateKey**: Insert returns duplicate key error → returns nil (idempotent)
       - **TestClickEventConsumer_DBError**: Insert returns other error → returns error (retry)
       - **TestResolveDeviceType**: Various user agent strings → correct device types
       - **TestResolveTrafficSource**: Various referer URLs → correct traffic source classification
       - **TestResolveCountry_NilGeoDB**: No GeoIP database → returns "XX"

       ```go
       package mqs

       import (
         "context"
         "encoding/json"
         "testing"

         "go-shortener/common/events"
         "go-shortener/services/analytics-consumer/internal/config"
         "go-shortener/services/analytics-consumer/internal/svc"
         "go-shortener/services/analytics-rpc/model"

         "github.com/stretchr/testify/assert"
       )
       ```

       **Note:** The consumer's helper functions (`resolveCountry`, `resolveDeviceType`, `resolveTrafficSource`) can be tested directly since they are package-level functions. Test these with table-driven tests for comprehensive coverage.
  </action>
  <verify>
    - `go test ./services/analytics-rpc/internal/logic/...` passes
    - `go test ./services/analytics-consumer/internal/mqs/...` passes
    - `go test -cover ./services/analytics-rpc/internal/logic/...` shows 80%+ coverage
    - `go test -cover ./services/analytics-consumer/internal/mqs/...` shows 80%+ coverage
  </verify>
  <done>Unit tests for GetClickCount logic and ClickEvent consumer with enrichment function tests</done>
</task>

<task type="auto">
  <name>Task 4: Add test Makefile targets and verify overall coverage</name>
  <files>
    Makefile
  </files>
  <action>
    1. **Update `Makefile`** to add test targets:
       ```makefile
       .PHONY: test test-cover test-cover-html

       test: ## Run all tests
       	go test ./...

       test-cover: ## Run tests with coverage summary
       	go test -cover ./services/...

       test-cover-html: ## Generate HTML coverage report
       	go test -coverprofile=coverage.out ./services/...
       	go tool cover -html=coverage.out -o coverage.html
       	@echo "Coverage report: coverage.html"
       ```

    2. **Add `coverage.out` and `coverage.html` to `.gitignore`** if not already present.

    3. **Run `go test -cover ./services/...`** to verify overall coverage meets 80% target.
  </action>
  <verify>
    - `make test` runs all tests and passes
    - `make test-cover` shows coverage percentages per package
    - Logic packages show 80%+ coverage
    - `go test ./...` passes with no failures
  </verify>
  <done>Makefile has test targets, all tests pass, 80%+ coverage on logic packages</done>
</task>

</tasks>

<verification>
1. `go test ./...` passes all tests (zero failures)
2. `go test -cover ./services/url-api/internal/logic/...` shows 80%+ per package
3. `go test -cover ./services/analytics-rpc/internal/logic/...` shows 80%+
4. `go test -cover ./services/analytics-consumer/internal/mqs/...` shows 80%+
5. Mock implementations compile and satisfy interfaces
6. Tests cover: success paths, not-found errors, DB errors, RPC failures, graceful degradation
7. Consumer enrichment functions have table-driven tests
8. `make test` and `make test-cover` work correctly
</verification>

<success_criteria>
- Unit tests for all 7 logic/consumer functions
- Mock UrlsModel, ClicksModel, and Analytics RPC client
- Tests cover success, not-found, DB error, and RPC failure paths
- Redirect test handles async Kafka publishing correctly (doesn't block on it)
- GetLinkDetail test verifies graceful degradation (0 clicks on RPC failure)
- Consumer enrichment functions tested with table-driven tests
- 80%+ test coverage on logic packages
- All tests pass with `go test ./...`
- Makefile has test, test-cover, test-cover-html targets
</success_criteria>

<output>
After completion, create `.planning/phases/10-resilience-infrastructure/10-03-SUMMARY.md`
</output>
