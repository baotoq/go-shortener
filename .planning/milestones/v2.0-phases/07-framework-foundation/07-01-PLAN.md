---
phase: 07-framework-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - Makefile
  - CLAUDE.md
  - internal/
  - cmd/
  - dapr/
  - dapr.yaml
  - db/
  - sqlc.yaml
  - test/
  - Dockerfile.url-service
  - Dockerfile.analytics-service
  - docker-compose.yml
  - services/url-api/.gitkeep
  - services/analytics-rpc/.gitkeep
  - common/events/events.go
  - pkg/problemdetails/problemdetails.go
  - .editorconfig
autonomous: true

must_haves:
  truths:
    - "Old v1.0 code (Chi, Dapr, SQLite, sqlc, Zap) is fully removed from the codebase"
    - "go-zero framework is installed and importable"
    - "goctl CLI is installed and runnable"
    - "Project directory structure follows go-zero monorepo convention (services/, pkg/, common/)"
    - "go.mod has go-zero as dependency and no Chi/Dapr/SQLite/Zap dependencies"
  artifacts:
    - path: "go.mod"
      provides: "Clean module with go-zero dependency"
      contains: "github.com/zeromicro/go-zero"
    - path: "services/"
      provides: "Service directory for url-api and analytics-rpc"
    - path: "common/events/events.go"
      provides: "Shared event types migrated from internal/shared/events"
    - path: "pkg/problemdetails/problemdetails.go"
      provides: "RFC 7807 Problem Details (preserved from v1.0)"
  key_links:
    - from: "go.mod"
      to: "github.com/zeromicro/go-zero"
      via: "go get"
      pattern: "zeromicro/go-zero"
---

<objective>
Clean break from v1.0 codebase and establish go-zero project scaffold.

Purpose: Remove all old Chi/Dapr/SQLite code and dependencies. Install go-zero framework. Create the monorepo directory structure (services/, pkg/, common/) that all subsequent plans build upon.

Output: Clean repository with go-zero installed, directory scaffold ready, shared code migrated.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-framework-foundation/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove v1.0 code and dependencies</name>
  <files>
    internal/
    cmd/
    dapr/
    dapr.yaml
    db/
    sqlc.yaml
    test/
    Dockerfile.url-service
    Dockerfile.analytics-service
    docker-compose.yml
    coverage.out
    bin/
    go.mod
    go.sum
  </files>
  <action>
  Delete ALL old v1.0 code and configuration. This is a clean break per user decision.

  **Delete these directories entirely:**
  - `internal/` (all of urlservice/, analytics/, shared/, testutil/)
  - `cmd/` (url-service, analytics-service entry points)
  - `dapr/` (Dapr components)
  - `db/` (sqlc SQL files)
  - `test/` (integration tests)
  - `bin/` (build output)

  **Delete these files:**
  - `dapr.yaml` (Dapr multi-app config)
  - `sqlc.yaml` (sqlc config)
  - `Dockerfile.url-service`
  - `Dockerfile.analytics-service`
  - `docker-compose.yml`
  - `coverage.out`

  **Clean go.mod — remove old dependencies:**
  Remove from go.mod `require` block:
  - `github.com/dapr/go-sdk` (Dapr)
  - `github.com/go-chi/chi/v5` (Chi router)
  - `github.com/golang-migrate/migrate/v4` (migrations)
  - `modernc.org/sqlite` (SQLite)
  - `go.uber.org/zap` (Zap logger)
  - `golang.org/x/time` (rate limiter)
  - `github.com/stretchr/testify` (keep only if go-zero tests need it, otherwise remove)

  Keep these in go.mod (still needed or will be needed):
  - `github.com/matoous/go-nanoid/v2` (NanoID generation — still used for short codes)
  - `github.com/mileusna/useragent` (UA parsing — needed in Phase 9)
  - `github.com/oschwald/geoip2-golang` (GeoIP — needed in Phase 9)

  After removing requires, run `go mod tidy` to clean indirect dependencies.

  **DO NOT delete:**
  - `pkg/problemdetails/` (preserved, moved to new structure)
  - `Makefile` (will be updated in this task)
  - `CLAUDE.md` (will be updated)
  - `.planning/` (planning docs)
  - `.editorconfig`
  - `README.md`
  - `.github/` (CI — will be updated in Phase 10)
  - `data/` (GeoIP database if present)

  **Update Makefile** to remove all old targets. Replace with placeholder:

  ```makefile
  .PHONY: help
  help: ## Show this help
  	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'
  ```

  The Makefile will get proper targets in Plans 02 and 03 when services exist.
  </action>
  <verify>
  Run these checks:
  - `ls internal/ cmd/ dapr/ db/ test/ 2>&1` should all report "No such file or directory"
  - `test ! -f dapr.yaml && test ! -f sqlc.yaml && echo "OK"` should print OK
  - `grep -c "dapr\|go-chi\|golang-migrate\|modernc.org/sqlite\|go.uber.org/zap" go.mod` should be 0
  - `go mod tidy` should complete without errors
  </verify>
  <done>All v1.0 code, tests, Dapr config, SQLite, Chi, Zap removed. go.mod contains only retained dependencies. Repository is clean.</done>
</task>

<task type="auto">
  <name>Task 2: Install go-zero and create project scaffold</name>
  <files>
    go.mod
    go.sum
    services/url-api/.gitkeep
    services/analytics-rpc/.gitkeep
    common/events/events.go
    pkg/problemdetails/problemdetails.go
    CLAUDE.md
  </files>
  <action>
  **Install go-zero framework:**

  ```bash
  go get -u github.com/zeromicro/go-zero@latest
  go install github.com/zeromicro/go-zero/tools/goctl@latest
  ```

  Verify goctl installed: `goctl --version`

  Also install protoc plugins for zRPC (needed in Plan 03):

  ```bash
  go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
  go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
  ```

  **Create directory scaffold:**

  ```
  services/
    url-api/        (empty, Plan 02 populates)
    analytics-rpc/  (empty, Plan 03 populates)
  common/
    events/         (shared event types)
  pkg/
    problemdetails/ (already exists, preserve)
  ```

  Create `.gitkeep` files in `services/url-api/` and `services/analytics-rpc/` so directories are tracked.

  **Migrate shared event types:**

  Create `common/events/events.go` with the event types from v1.0's `internal/shared/events/`. Read the old code first from git history if needed, or recreate based on existing knowledge:

  ```go
  package events

  // ClickEvent represents a URL redirect event published to the message queue.
  // Phase 7: Type definition only. Phase 9 will wire Kafka producer/consumer.
  type ClickEvent struct {
      ShortCode string `json:"short_code"`
      Timestamp int64  `json:"timestamp"`
      IP        string `json:"ip"`
      UserAgent string `json:"user_agent"`
      Referer   string `json:"referer"`
  }
  ```

  Note: The ClickEvent in v1.0 had short_code and timestamp. The v2.0 version adds IP, UserAgent, Referer fields that were previously extracted in the analytics enrichment layer. Moving them into the event simplifies the consumer. This is a Claude discretion decision — enrichment data travels with the event.

  **Update pkg/problemdetails/problemdetails.go:**

  Add a `ValidationError` type to support per-field validation errors (locked decision). Add an `Errors` field to `ProblemDetail`:

  ```go
  package problemdetails

  import "fmt"

  const (
      TypeInvalidURL        = "invalid-url"
      TypeNotFound          = "not-found"
      TypeRateLimitExceeded = "rate-limit-exceeded"
      TypeInternalError     = "internal-error"
      TypeValidationError   = "validation-error"
  )

  type FieldError struct {
      Field   string `json:"field"`
      Message string `json:"message"`
  }

  type ProblemDetail struct {
      Type   string       `json:"type"`
      Title  string       `json:"title"`
      Status int          `json:"status"`
      Detail string       `json:"detail"`
      Errors []FieldError `json:"errors,omitempty"`
  }

  func New(status int, problemType, title, detail string) *ProblemDetail {
      return &ProblemDetail{
          Type:   fmt.Sprintf("https://api.example.com/problems/%s", problemType),
          Title:  title,
          Status: status,
          Detail: detail,
      }
  }

  func NewValidation(errors []FieldError) *ProblemDetail {
      return &ProblemDetail{
          Type:   fmt.Sprintf("https://api.example.com/problems/%s", TypeValidationError),
          Title:  "Validation Failed",
          Status: 400,
          Detail: "Request validation failed",
          Errors: errors,
      }
  }
  ```

  **Update CLAUDE.md** to reflect new v2.0 structure. Replace architecture section:

  ```markdown
  ## Architecture

  Two microservices using go-zero framework:

  - **url-api** (services/url-api): URL shortening API. go-zero REST service with .api spec code generation.
  - **analytics-rpc** (services/analytics-rpc): Analytics zRPC service. Protobuf-generated gRPC server.

  Each service follows go-zero convention: Handler → Logic → ServiceContext
  Generated code from .api/.proto specs. Business logic in logic/ only.

  ```
  services/{service}/
  ├── {service}.api or .proto  # Spec file (source of truth)
  ├── {service}.go             # Main entry point
  ├── etc/
  │   └── {service}.yaml       # Configuration
  └── internal/
      ├── config/              # Config struct
      ├── handler/             # HTTP handlers (generated)
      ├── logic/               # Business logic (manual)
      ├── svc/                 # ServiceContext (DI)
      └── types/               # Request/response types (generated)
  ```

  ## Commands

  ```bash
  goctl api go -api services/url-api/url.api -dir services/url-api -style gozero   # Regenerate URL service
  goctl rpc protoc services/analytics-rpc/analytics.proto --go_out=services/analytics-rpc --go-grpc_out=services/analytics-rpc --zrpc_out=services/analytics-rpc --style gozero  # Regenerate Analytics service
  ```

  ## Key Patterns

  - **goctl code generation**: .api/.proto specs generate handlers, types, routes. Never edit generated types.go.
  - **Handler/Logic separation**: Handlers parse requests. Logic contains business rules. Never mix.
  - **ServiceContext**: Dependency injection container. Initialized once, passed to all logic constructors.
  - **RFC 7807 Problem Details**: Custom httpx.SetErrorHandler maps errors to Problem Details format.
  - **Validation via tags**: .api type tags (range, options, optional, default) handle all request validation.
  - **logx structured logging**: go-zero's built-in logger with context propagation.
  ```

  Run `go mod tidy` after all changes.
  </action>
  <verify>
  Run these checks:
  - `goctl --version` returns a version number
  - `grep "zeromicro/go-zero" go.mod` finds go-zero dependency
  - `ls services/url-api/ services/analytics-rpc/` both exist
  - `ls common/events/events.go` exists
  - `ls pkg/problemdetails/problemdetails.go` exists
  - `go build ./pkg/... ./common/...` compiles without errors
  </verify>
  <done>go-zero installed and importable. goctl CLI available. Directory scaffold created (services/, common/, pkg/). Shared types migrated. problemdetails updated with validation error support. CLAUDE.md reflects v2.0 structure.</done>
</task>

</tasks>

<verification>
1. `ls internal/ cmd/ dapr/ db/ test/ 2>&1 | grep -c "No such file"` equals 5
2. `goctl --version` succeeds
3. `grep -c "go-zero" go.mod` is at least 1
4. `grep -c "dapr\|go-chi\|golang-migrate\|modernc.org/sqlite\|go.uber.org/zap" go.mod` is 0
5. `go build ./pkg/... ./common/...` succeeds
6. `ls services/url-api/ services/analytics-rpc/ common/events/` all succeed
</verification>

<success_criteria>
- All v1.0 code removed (internal/, cmd/, dapr/, db/, test/, Dockerfiles, docker-compose)
- Old dependencies removed from go.mod (Chi, Dapr, SQLite, Zap, golang-migrate)
- go-zero installed and verified via `goctl --version`
- Directory scaffold exists: services/url-api/, services/analytics-rpc/, common/events/, pkg/problemdetails/
- Shared event types and problem details compile: `go build ./pkg/... ./common/...`
</success_criteria>

<output>
After completion, create `.planning/phases/07-framework-foundation/07-01-SUMMARY.md`
</output>
